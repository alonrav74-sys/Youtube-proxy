<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ChordFinderPro v14.36 ğŸ”¬ DEBUG MODE</title>
  
  <style>
    :root{--bg:#0b1022;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--card:#0a1324;--border:#1b2333;--brand:#22c55e;--accent:#38bdf8;--alert:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);direction:rtl}
    .wrap{max-width:1400px;margin:auto;padding:18px;padding-bottom:80px}
    h1{margin:6px 0 10px;font-size:24px}
    .muted{color:var(--muted);font-size:14px}
    .panel{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"], select, button, input[type="number"], input[type="text"]{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;appearance:none;font-weight:700;cursor:pointer}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1221;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3d55;margin:2px 4px;background:#0b1221}
    .ok{border-color:#1f5f3f;color:#d7ffe6;background:#0d2e1f}
    .err{border-color:#5f2323;color:#ffe0e0;background:#3f1d1d}
    .warn{border-color:#8a6a1f;color:#fff0d9;background:#3a2a0c}
    
    /* ğŸ”¬ DEBUG TABLE STYLES */
    .debug-table{
      width:100%;
      border-collapse:collapse;
      margin-top:15px;
      font-size:12px;
      background:#0a1324;
      border-radius:8px;
      overflow:hidden;
    }
    .debug-table th{
      background:#1a2332;
      color:#38bdf8;
      padding:10px 8px;
      text-align:center;
      font-weight:700;
      border-bottom:2px solid #2a3d55;
      font-size:11px;
    }
    .debug-table td{
      padding:8px;
      border-bottom:1px solid #1f2a40;
      text-align:center;
    }
    .debug-table tr:hover{
      background:#12203a;
    }
    .debug-table .chord-col{
      font-weight:700;
      color:#22c55e;
      font-size:14px;
    }
    .debug-table .changed{
      color:#f59e0b;
      font-weight:700;
    }
    .debug-table .arrow{
      color:#94a3b8;
      font-size:16px;
    }
    .filter-section{
      background:#0a1324;
      padding:12px;
      border-radius:8px;
      margin-top:10px;
      border:1px solid #2a3d55;
    }
    .filter-btn{
      padding:6px 12px;
      border-radius:6px;
      background:#1a2332;
      border:1px solid #2a3d55;
      color:#cbd5e1;
      cursor:pointer;
      font-size:12px;
      margin:4px;
    }
    .filter-btn.active{
      background:#0d2e1f;
      border-color:#22c55e;
      color:#d7ffe6;
    }
    .base-col { text-align: center; }
    .refiner-col { text-align: center; }
    .bass-col { text-align: center; }
    .final-col { text-align: center; background: #1e3a1e; color: #a7f3a7; font-weight: 700; }
    .base-col.winner { background: #fef3c7; color: #92400e; font-weight: 600; }
    .refiner-col.winner { background: #dcfce7; color: #166534; font-weight: 600; }
    .bass-col.winner { background: #dbeafe; color: #1e40af; font-weight: 600; }
  </style>
</head>
<body>

  <div class="wrap">
    <h1>ğŸ”¬ Chord Finder Pro v14.36 - DEBUG MODE
      <span class="badge" style="background:#3a2a0c;border-color:#f59e0b">ğŸ” Full Analysis</span>
    </h1>
    <div class="muted">
      × ×™×ª×•×— ××¤×•×¨×˜ ××§×•×¨×“-××§×•×¨×“: ×× ×•×¢ ×‘×¡×™×¡×™ â†’ Refiner â†’ BassEngine
    </div>

    <section class="panel">
      <div class="row">
        <input id="file" type="file" accept="audio/*,video/*" />
        <label>ğŸ¸ ×§××¤×•:
          <input id="capo" type="number" value="0" min="0" max="11" style="width:80px" />
        </label>
        <button id="analyzeBtn">ğŸ” × ×ª×— + ×“×™×‘××’ ××œ×</button>
        <button id="downloadCsvBtn" disabled>ğŸ’¾ ×”×•×¨×“ CSV ××¤×•×¨×˜</button>
      </div>
      
      <div id="status" class="pill ok" style="display:none"></div>
      <div id="error" class="pill err" style="display:none"></div>
    </section>

    <section class="panel">
      <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
      <div class="row">
        <span class="badge">×¡×”"×›: <b id="totalChords">â€”</b></span>
        <span class="badge">×‘×¡×™×¡: <b id="baseChords">â€”</b></span>
        <span class="badge">ğŸµ Refiner ×©×™× ×”: <b id="refinerChanges">â€”</b></span>
        <span class="badge">ğŸ¸ Bass ×©×™× ×”: <b id="bassChanges">â€”</b></span>
      </div>
    </section>

    <!-- ğŸ”¬ DEBUG TABLE -->
    <section class="panel">
      <h2>ğŸ”¬ × ×™×ª×•×— ××¤×•×¨×˜ ××§×•×¨×“-××§×•×¨×“</h2>
      
      <!-- Filters -->
      <div class="filter-section">
        <div style="font-weight:700;margin-bottom:8px;color:#38bdf8">ğŸ¯ ×¡×™× ×•×Ÿ:</div>
        <button class="filter-btn active" data-filter="all">×”×›×œ</button>
        <button class="filter-btn" data-filter="refiner">×¨×§ Refiner ×©×™× ×”</button>
        <button class="filter-btn" data-filter="bass">×¨×§ Bass ×©×™× ×”</button>
        <button class="filter-btn" data-filter="changed">×›×œ ×”×©×™× ×•×™×™×</button>
      </div>
      
      <div style="overflow-x:auto;max-height:600px;overflow-y:auto">
        <table class="debug-table" id="debugTable">
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th style="width:60px">â±ï¸ ×–××Ÿ</th>
              <th style="width:80px">ğŸ¼ ×× ×•×¢<br>×‘×¡×™×¡×™</th>
              <th style="min-width:120px">ğŸµ Refiner<br><small style="font-weight:400;color:#64748b">××–'×•×¨/××™× ×•×¨</small></th>
              <th style="min-width:120px">ğŸ¸ Bass<br><small style="font-weight:400;color:#64748b">××™× ×‘×¨×¡×™×•×ª</small></th>
              <th style="width:80px">âœ… ×”×—×œ×˜×”<br>×¡×•×¤×™×ª</th>
              <th style="min-width:200px">ğŸ“ ×”×¢×¨×•×ª</th>
            </tr>
          </thead>
          <tbody id="debugTableBody">
            <tr><td colspan="7" style="color:#94a3b8;padding:30px">×××ª×™×Ÿ ×œ× ×™×ª×•×—...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </div>

<!-- âœ… Scripts - ×©×™× ××ª ×”×§×‘×¦×™× ×”×—×“×©×™×! -->
<script src="BassEngine_FINAL_v3.js"></script>
<script src="MajorMinorRefiner_FINAL_v3.js"></script>
<script src="ChordEngine_v14.36_RESTORED.js"></script>
<script src="ChordDebugger_FINAL_v3.js"></script>

<script>
let engine;
let DEBUG_DATA = null;

window.addEventListener('DOMContentLoaded', () => {
  if (typeof ChordEngineEnhanced === 'undefined') {
    alert('âŒ ChordEngine ×œ× × ×˜×¢×Ÿ!');
    throw new Error('Engine not loaded');
  }
  try {
    engine = new ChordEngineEnhanced();
    console.log('âœ… Debug mode initialized');
  } catch(e) {
    alert('âŒ ×©×’×™××”: ' + e.message);
    throw e;
  }
});

const fileEl = document.getElementById('file');
const analyzeBtn = document.getElementById('analyzeBtn');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const capoEl = document.getElementById('capo');
const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const debugTableBody = document.getElementById('debugTableBody');
const totalChordsEl = document.getElementById('totalChords');
const baseChordsEl = document.getElementById('baseChords');
const bassChangesEl = document.getElementById('bassChanges');
const refinerChangesEl = document.getElementById('refinerChanges');

function showStatus(msg, type = 'ok') {
  statusEl.textContent = msg;
  statusEl.className = `pill ${type}`;
  statusEl.style.display = 'inline-flex';
  errorEl.style.display = 'none';
}

function showError(msg) {
  errorEl.textContent = msg;
  errorEl.style.display = 'inline-flex';
  statusEl.style.display = 'none';
}

// ğŸ”¬ ANALYZE WITH FULL DEBUG
analyzeBtn.onclick = async () => {
  const f = fileEl.files?.[0];
  if (!f) {
    showError('×‘×—×¨ ×§×•×‘×¥');
    return;
  }
  
  showStatus('×˜×•×¢×Ÿ ××•×“×™×•...', 'warn');
  debugTableBody.innerHTML = '<tr><td colspan="7" style="color:#94a3b8;padding:30px">×× ×ª×—...</td></tr>';
  downloadCsvBtn.disabled = true;
  
  try {
    // Decode audio
    const audioData = await decodeAudio(f);
    
    showStatus('××¨×™×¥ ×× ×•×¢ ×‘×¡×™×¡×™...', 'warn');
    
    // ğŸ¯ Run chord detection with ALL engines
    const result = await engine.detect(audioData.audioBuffer, {
      useBassEngine: true,
      useMajorMinorRefiner: true,
      bassMultiplier: 1.2,
      minConfidenceToOverride: 0.40,
      decisionThreshold: 0.15,
      debug: true
    });
    
    // ğŸ”¬ Build debug data structure
    const capoValue = parseInt(capoEl.value || '0', 10);
    DEBUG_DATA = ChordDebugger.buildDebugData(result, capoValue);
    
    // Update stats
    totalChordsEl.textContent = DEBUG_DATA.length;
    baseChordsEl.textContent = DEBUG_DATA.length;
    refinerChangesEl.textContent = DEBUG_DATA.filter(d => d.refinerApplied).length;
    bassChangesEl.textContent = DEBUG_DATA.filter(d => d.bassApplied).length;
    
    // Render table
    debugTableBody.innerHTML = ChordDebugger.renderTable(DEBUG_DATA, 'all');
    
    showStatus(`âœ… × ×™×ª×•×— ×”×•×©×œ× - ${DEBUG_DATA.length} ××§×•×¨×“×™×`, 'ok');
    downloadCsvBtn.disabled = false;
    
    console.log('ğŸ”¬ Debug Data:', DEBUG_DATA);
    
  } catch (e) {
    console.error(e);
    showError('âŒ ×©×’×™××”: ' + e.message);
  }
};

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    if (!DEBUG_DATA) return;
    
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    const filter = this.dataset.filter;
    debugTableBody.innerHTML = ChordDebugger.renderTable(DEBUG_DATA, filter);
  });
});

// ğŸ’¾ Download CSV
downloadCsvBtn.onclick = () => {
  if (!DEBUG_DATA) {
    alert('××™×Ÿ × ×ª×•× ×™×');
    return;
  }
  ChordDebugger.downloadCSV(DEBUG_DATA, `chord_debug_${new Date().toISOString().slice(0,10)}.csv`);
};

// Audio decoding
async function decodeAudio(file) {
  const AC = window.AudioContext || window.webkitAudioContext;
  const ctx = new AC();
  try { await ctx.resume(); } catch {}
  
  const arr = await file.arrayBuffer();
  const buf = await ctx.decodeAudioData(arr.slice(0));
  
  return {
    audioBuffer: buf,
    sr: buf.sampleRate,
    bpm: 120,
    duration: buf.duration,
    url: URL.createObjectURL(file)
  };
}
</script>

</body>
</html>
