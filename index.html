<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChordFinderPro 🎸 AI Enhanced</title>
  <meta name="theme-color" content="#0b1022" />
  <style>
    :root{--bg:#0b1022;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--card:#0a1324;--border:#1b2333;--brand:#22c55e;--accent:#38bdf8;--alert:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);direction:rtl}
    .wrap{max-width:1200px;margin:auto;padding:18px}
    h1{margin:6px 0 10px;font-size:24px}
    .muted{color:var(--muted);font-size:14px}
    .panel{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"], select, button, input[type="number"], input[type="text"]{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;appearance:none;font-weight:700;cursor:pointer}
    input[type="text"]{width:100%;max-width:500px;font-weight:400}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1221;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px}
    .badge.ai{border-color:#23664d;background:#0d2e1f;color:#d7ffe6}
    .badge.pro{border-color:#664d23;background:#2e1f0d;color:#ffd7a3}
    .badge.whisper{border-color:#38bdf8;background:#0a1f2e;color:#bae6fd}
    .badge.ensemble{border-color:#8b5cf6;background:#1e1b4b;color:#ddd6fe}
    .live{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:18px;margin-top:10px}
    .live .title{color:#a9b4c8;font-size:13px}
    .live .ch{font-weight:800;font-size:42px}
    .live .func{font-size:14px;color:#38bdf8;margin-top:4px}
    .live .lyric{font-size:18px;color:#cbd5e1;margin-top:12px;font-style:italic;direction:rtl;line-height:1.6;background:#0a1324;padding:10px;border-radius:8px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3d55;margin:2px 4px;background:#0b1221}
    .ok{border-color:#1f5f3f;color:#d7ffe6;background:#0d2e1f}
    .err{border-color:#5f2323;color:#ffe0e0;background:#3f1d1d}
    .warn{border-color:#8a6a1f;color:#fff0d9;background:#3a2a0c}
    .spin{width:12px;height:12px;border-radius:50%;border:2px solid var(--accent);border-top-color:transparent;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#0b1221;border:1px solid #1f2a40;font-size:12px}
    .chip .dot{width:6px;height:6px;border-radius:50%;background:#22c55e}
    .chip.ornament{border-color:#8a6a1f;background:#2a2010}
    .chip.structural{border-color:#1f5f3f;background:#0d2e1f}
    .sliderRow{display:flex;align-items:center;gap:10px;margin-top:8px}
    input[type="range"]{width:220px}
    .tag{font-size:12px;color:#cbd5e1;border:1px solid #1f2a40;padding:4px 8px;border-radius:999px;background:#0b1221}
    .analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-top:12px}
    .analysis-card{background:#0b1221;border:1px solid #1f2a40;border-radius:12px;padding:12px}
    .analysis-card h3{margin:0 0 8px 0;font-size:14px;color:#38bdf8}
    .analysis-card .value{font-size:20px;font-weight:700;color:#22c55e}
    .yt-result{display:flex;gap:10px;padding:10px;border:1px solid #1f2a40;border-radius:10px;margin-top:8px;align-items:center;cursor:pointer;transition:all 0.2s}
    .yt-result:hover{background:#12203a;border-color:#38bdf8}
    .yt-result.selected{background:#164e3a;border-color:#22c55e}
    .yt-result img.thumb{width:120px;height:68px;object-fit:cover;border-radius:8px;flex-shrink:0}
    .yt-result .info{flex:1;min-width:0}
    .yt-result .title{font-weight:700;margin-bottom:4px;color:#e5e7eb;word-wrap:break-word;white-space:normal;line-height:1.3}
    .yt-result .channel{font-size:12px;color:#94a3b8}
    .yt-results{max-height:400px;overflow-y:auto}
    .tabs{display:flex;gap:4px;margin-bottom:12px}
    .tab{padding:8px 16px;border-radius:8px;background:#0b1221;border:1px solid #1f2a40;cursor:pointer;transition:all 0.2s}
    .tab.active{background:#0d2e1f;border-color:#22c55e;color:#d7ffe6}
    .tab:hover{border-color:#38bdf8}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .info-box{background:#1f2a40;padding:10px;border-radius:8px;margin-top:8px;font-size:13px;color:#cbd5e1}
    .info-box.success{background:#0d2e1f;border:1px solid #22c55e}
    .synced-sheet{background:#fff;color:#000;padding:20px;border-radius:8px;font-family:'Courier New',Courier,monospace;line-height:2.5;overflow-x:auto;max-width:100%;white-space:pre-wrap}
    .synced-sheet.rtl{direction:rtl;text-align:right}
    .synced-sheet.ltr{direction:ltr;text-align:left}
    
    /* Full sheet tab - traditional chord/lyric lines */
    .chord-line{color:#2563eb;font-weight:700;font-size:14px;margin:0;white-space:pre;font-family:'Courier New',Courier,monospace;line-height:1.2}
    .lyric-line{color:#000;font-size:16px;margin:0 0 16px 0;white-space:pre;font-family:'Courier New',Courier,monospace;line-height:1.2}
    
    /* Live sheet - progressive chord display */
    .lyrics-container{display:block;width:100%}
    .lyric-line-container{display:block;margin-bottom:20px;white-space:nowrap;overflow-x:auto}
    .word-slot{display:inline-block;position:relative;vertical-align:top;margin:0 4px;white-space:nowrap}
    .chord-slot{display:block;color:#2563eb;font-weight:700;font-size:13px;line-height:1.2;min-height:18px;text-align:center;transition:all 0.3s}
    .chord-slot.active{background:#fef3c7;color:#92400e;border-radius:4px;padding:2px 4px;transform:scale(1.15);animation:chordPop 0.3s ease-out}
    .word-text{display:block;color:#000;font-size:16px;line-height:1.5;text-align:center}
    .word-slot.spacer .word-text{color:#999;font-size:14px}
    
    @keyframes chordPop{
      0%{transform:scale(0.8);opacity:0}
      50%{transform:scale(1.2)}
      100%{transform:scale(1);opacity:1}
    }
    
    /* 🆕 AI Mode Selector */
    .mode-selector{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .mode-btn{flex:1;min-width:120px;padding:10px 12px;border-radius:10px;border:2px solid #2a3d55;background:#0b1221;color:#cbd5e1;cursor:pointer;transition:all 0.3s;text-align:center;font-size:13px;font-weight:700}
    .mode-btn:hover{border-color:#38bdf8;transform:translateY(-2px)}
    .mode-btn.active{border-color:#22c55e;background:#0d2e1f;color:#d7ffe6}
    .mode-btn small{display:block;font-size:11px;margin-top:4px;opacity:0.8;font-weight:400}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🎵 Chord Finder Pro 🎯
      <span class="badge pro">Professional</span>
      <span class="badge whisper">Groq Whisper</span>
      <span class="badge ensemble">Key-Constrained</span>
    </h1>
    <div class="muted">
      אקורדים מעל מילים בזמן אמת + דף נגינה מלא. RTL/LTR אוטומטי. 🎼 Key-Constrained Detection<br>
      <small style="opacity:0.7;font-size:11px">
        Powered by <strong>Groq Whisper</strong> • 
        Harmonic Theory • 
        Built by <strong>Alon</strong>
      </small>
    </div>

    <section class="panel">
      <div class="tabs">
        <div class="tab active" data-tab="file">📁 קובץ מקומי</div>
        <div class="tab" data-tab="youtube">🎬 יוטיוב</div>
        <div class="tab" data-tab="sheet">📝 דף נגינה</div>
      </div>

      <div id="fileTab" class="tab-content active">
        <div class="row">
          <input id="file" type="file" accept="audio/*,video/*" />
        </div>
      </div>

      <div id="youtubeTab" class="tab-content">
        <div class="info-box success">
          ⚡ סנכרון מדויק: אקורד על מילה/בין מילים לפי הזמן המדויק.
        </div>
        
        <div class="row" style="margin-top:12px">
          <input id="ytSearch" type="text" placeholder='חפש שיר (למשל: "Leonard Cohen Hallelujah")' />
          <button id="ytSearchBtn">🔍 חפש</button>
        </div>
        
        <div id="ytResults" class="yt-results" style="display:none"></div>
        
        <div style="margin-top:12px">
          <div style="margin-bottom:8px;font-weight:700">או הדבק קישור יוטיוב:</div>
          <div class="row">
            <input id="ytUrl" type="text" placeholder="https://www.youtube.com/watch?v=..." style="flex:1" />
            <button id="ytUrlBtn">✓ השתמש</button>
          </div>
        </div>
        
        <div id="ytStatus" class="pill" style="display:none;margin-top:8px"></div>
        <div id="whisperStatus" class="pill warn" style="display:none;margin-top:8px">
          <span class="spin"></span> 🎤 Groq Whisper עובד ברקע...
        </div>
      </div>

      <div id="sheetTab" class="tab-content">
        <h3>📋 דף נגינה מקצועי</h3>
        <div id="fullSheet" class="synced-sheet">—</div>
        
        <h3 style="margin-top:16px">🎤 תמלול מלא</h3>
        <div id="fullTranscript" style="max-height:300px;overflow:auto;background:#0b1221;padding:12px;border-radius:8px;white-space:pre-wrap;font-family:Arial">—</div>
        
        <div class="row" style="margin-top:12px">
          <button id="exportBtn">💾 ייצא ל-ChordPro</button>
          <button id="copyBtn">📋 העתק דף</button>
        </div>
      </div>

      <!-- 🆕 AI Mode Selector -->
      <div style="margin-top:16px">
        <h3 style="margin:0 0 8px 0;font-size:14px;color:#38bdf8">🤖 מצב זיהוי AI</h3>
        <div class="mode-selector">
          <button class="mode-btn" data-mode="fast">
            ⚡ Fast
            <small>בסיסי<br>~2-5 שניות</small>
          </button>
          <button class="mode-btn active" data-mode="balanced">
            ⚖️ Balanced
            <small>+ Key Constraint<br>~5-10 שניות</small>
          </button>
          <button class="mode-btn" data-mode="accurate">
            🎯 Accurate
            <small>+ Harmonic Logic<br>~10-15 שניות</small>
          </button>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <label>מצב זיהוי:
          <select id="extMode">
            <option value="basic">בסיסי</option>
            <option value="jazz" selected>ג'אז (7/9/11/13)</option>
            <option value="pro">מקצועי</option>
          </select>
        </label>
        <label>קוואנטה:
          <select id="quant">
            <option value="4" selected>1/4</option>
            <option value="8">1/8</option>
          </select>
        </label>
        <label>🎸 קאפו:
          <input id="capo" type="number" value="0" min="0" max="11" style="width:80px" />
        </label>
        <button id="analyzeBtn">נתח</button>
        <button id="playBtn" disabled>🎧 הפעל</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge">BPM: <b id="bpm">—</b></span>
        <span class="badge">משך: <b id="dur">—</b></span>
        <span class="badge" style="cursor:pointer" title="לחץ להחלפת מז'ור/מינור">
          סולם: <b id="keyBadge" onclick="toggleMajorMinor()">—</b>
        </span>
        <button onclick="transposeDown()" style="padding:4px 10px;font-size:12px" title="הורד חצי טון">🎵↓</button>
        <button onclick="transposeUp()" style="padding:4px 10px;font-size:12px" title="העלה חצי טון">↑🎵</button>
        <span class="badge">מצב: <b id="modeBadge">—</b></span>
        <span id="aiBadge" class="badge ai" style="display:none">🎼 Key-Constrained</span>
      </div>

      <div id="status" class="pill ok" style="display:none"></div>
      <div id="error" class="pill err" style="display:none"></div>

      <div class="sliderRow">
        <span class="tag">×<span id="bassMulTxt">1.25</span></span>
        <input id="bassSens" type="range" min="0.5" max="2.0" step="0.05" value="1.25" />
        <span style="color:#94a3b8;font-size:12px">רגישות בס</span>
      </div>
      <div class="sliderRow">
        <span class="tag">×<span id="decMulTxt">1.00</span></span>
        <input id="decSens" type="range" min="0.5" max="2.0" step="0.05" value="1.00" />
        <span style="color:#94a3b8;font-size:12px">רגישות הרחבות</span>
      </div>

      <div class="row">
        <span id="gateChip" class="chip warn" style="display:none"><span class="dot"></span>מחכה לפריטה...</span>
      </div>
    </section>

    <section class="panel">
      <h2>ניתוח הרמוני מתקדם</h2>
      <div class="analysis-grid">
        <div class="analysis-card">
          <h3>אקורדים מבניים</h3>
          <div class="value" id="structuralCount">—</div>
        </div>
        <div class="analysis-card">
          <h3>קישוטים</h3>
          <div class="value" id="ornamentCount">—</div>
        </div>
        <div class="analysis-card">
          <h3>דומיננט משני</h3>
          <div class="value" id="secDomCount">—</div>
        </div>
        <div class="analysis-card">
          <h3>השאלות מודאליות</h3>
          <div class="value" id="modalBorrowCount">—</div>
        </div>
      </div>
      
      <!-- 🆕 Confidence Booster Stats -->
      <div id="confidenceStats" style="display:none;margin-top:16px">
        <h3 style="margin:0 0 8px 0;font-size:14px;color:#8b5cf6">✨ Key-Constrained Detection Stats</h3>
        <div class="analysis-grid">
          <div class="analysis-card" style="border-color:#8b5cf6">
            <h3>High Confidence</h3>
            <div class="value" style="font-size:16px"><span id="highConfRate">—</span></div>
          </div>
          <div class="analysis-card" style="border-color:#8b5cf6">
            <h3>Key Fixes</h3>
            <div class="value" style="font-size:16px"><span id="keyFixCount">—</span> chords</div>
          </div>
          <div class="analysis-card" style="border-color:#8b5cf6">
            <h3>Secondary Dom.</h3>
            <div class="value" style="font-size:16px"><span id="secDomCount">—</span> found</div>
          </div>
        </div>
      </div>
      
      <h3 style="margin-top:16px">🎯 אקורדים טבעיים בסולם (Circle of Fifths)</h3>
      <div id="circleOfFifths" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">—</div>
    </section>

    <section class="panel">
      <h2>תצוגה חיה</h2>
      <audio id="player" controls preload="auto" crossorigin="anonymous" style="width:100%"></audio>
      <div class="live">
        <div style="flex:1">
          <div class="title">האקורד כרגע</div>
          <div class="ch" id="liveChord">—</div>
          <div class="func" id="liveFunction">—</div>
          <div class="lyric" id="liveLyric">—</div>
        </div>
        <div style="text-align:left">
          <span id="ornamentChip" class="chip ornament" style="display:none">קישוט</span>
          <span id="structuralChip" class="chip structural" style="display:none">מבני</span>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>📝 דף נגינה — זמן אמת</h2>
      <div id="liveSheet" class="synced-sheet">—</div>
      <div class="row" style="margin-top:8px">
        <button id="resetSheet">אפס דף</button>
      </div>
    </section>
  </div>

<!-- Load chord-engine.js first -->
<script src="chord-engine.js"></script>
<script src="sync-engine.js"></script>

<!-- Main application code -->
<script>
console.log('🎸 ChordFinder loading...');

// Check ChordEngine loaded
if(typeof ChordEngine === 'undefined') {
  alert('❌ שגיאה: chord-engine.js לא נטען!\n\nוודא ששני הקבצים באותה תיקייה.');
}

const engine = new ChordEngine();
const SERVER = window.location.origin;

let selectedYouTubeVideo = null;
let currentTab = 'file';
let currentAIMode = 'balanced';
let WHISPER_SEGMENTS = [];
let WHISPER_WORDS = [];
let WHISPER_TEXT = '';
let WHISPER_RUNNING = false;
let DETECTED_LANGUAGE = 'en';
let LIVE_STREAM = [];
let LIVE_POINTER = 0;

const fileEl=document.getElementById('file');
const analyzeBtn=document.getElementById('analyzeBtn');
const playBtn=document.getElementById('playBtn');
const statusEl=document.getElementById('status');
const errorEl=document.getElementById('error');
const whisperStatusEl=document.getElementById('whisperStatus');
const fullTranscriptEl=document.getElementById('fullTranscript');
const fullSheetEl=document.getElementById('fullSheet');
const gateChip=document.getElementById('gateChip');
const player=document.getElementById('player');
const bpmEl=document.getElementById('bpm');
const durEl=document.getElementById('dur');
const capoEl=document.getElementById('capo');
const keyBadge=document.getElementById('keyBadge');
const modeBadge=document.getElementById('modeBadge');
const liveChordEl=document.getElementById('liveChord');
const liveFunctionEl=document.getElementById('liveFunction');
const liveLyricEl=document.getElementById('liveLyric');
const liveSheetEl=document.getElementById('liveSheet');
const resetSheetBtn=document.getElementById('resetSheet');
const exportBtn=document.getElementById('exportBtn');
const copyBtn=document.getElementById('copyBtn');
const aiBadge=document.getElementById('aiBadge');
const ensembleBadge=document.getElementById('ensembleBadge');
const agreementRateEl=document.getElementById('agreementRate');
const bassSensEl=document.getElementById('bassSens');
const decSensEl=document.getElementById('decSens');
const bassMulTxt=document.getElementById('bassMulTxt');
const decMulTxt=document.getElementById('decMulTxt');
const structuralCountEl=document.getElementById('structuralCount');
const ornamentCountEl=document.getElementById('ornamentCount');
const secDomCountEl=document.getElementById('secDomCount');
const modalBorrowCountEl=document.getElementById('modalBorrowCount');
const ornamentChip=document.getElementById('ornamentChip');
const structuralChip=document.getElementById('structuralChip');
const ytSearchEl=document.getElementById('ytSearch');
const ytSearchBtn=document.getElementById('ytSearchBtn');
const ytResultsEl=document.getElementById('ytResults');
const ytStatusEl=document.getElementById('ytStatus');
const ytUrlEl=document.getElementById('ytUrl');
const ytUrlBtn=document.getElementById('ytUrlBtn');

bassSensEl.oninput=()=>bassMulTxt.textContent=Number(bassSensEl.value).toFixed(2);
decSensEl.oninput=()=>decMulTxt.textContent=Number(decSensEl.value).toFixed(2);

function initTabs() {
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.getAttribute('data-tab');
      currentTab = tabName;
      tabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      tabContents.forEach(content => content.classList.remove('active'));
      const targetContent = document.getElementById(tabName + 'Tab');
      if(targetContent) targetContent.classList.add('active');
      if(tabName === 'sheet') refreshSheetTabView();
    });
  });
}
initTabs();

async function runWhisperInBackground(videoId) {
  if(WHISPER_RUNNING) return;
  WHISPER_RUNNING = true;
  whisperStatusEl.style.display = 'inline-flex';
  whisperStatusEl.textContent = '⏳ Groq Whisper...';
  try {
    const r = await fetch(`${SERVER}/api/groq-transcribe`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ videoId: videoId })
    });
    if(!r.ok) throw new Error(`Failed: ${r.status}`);
    const data = await r.json();
    if(data.success) {
      WHISPER_SEGMENTS = data.segments || [];
      WHISPER_WORDS = data.words || [];
      WHISPER_TEXT = data.text || '';
      DETECTED_LANGUAGE = data.language || 'en';
      whisperStatusEl.textContent = '✓ Groq Whisper';
      whisperStatusEl.classList.remove('warn');
      whisperStatusEl.classList.add('ok');
      if(window.__STATE && window.__STATE.timeline) {
        syncChordsWithLyrics();
        refreshSheetTabView();
      }
      setTimeout(() => whisperStatusEl.style.display = 'none', 2500);
    } else {
      throw new Error(data.error || 'Failed');
    }
  } catch(e) {
    console.error('Error:', e);
    whisperStatusEl.textContent = '❌ שגיאה';
    whisperStatusEl.classList.add('err');
    setTimeout(() => whisperStatusEl.style.display = 'none', 4000);
  } finally {
    WHISPER_RUNNING = false;
  }
}

function syncChordsWithLyrics(){
  LIVE_STREAM = SyncEngine.syncChordsWithLyrics(window.__STATE, WHISPER_WORDS, capoEl.value, sanitizeLabel, applyCapoToLabel);
  LIVE_POINTER = 0;
}

function displayWhisperResult() {
  if(!WHISPER_TEXT || WHISPER_TEXT.trim() === '') {
    fullTranscriptEl.textContent = '💬 תמלול לא זמין';
    return;
  }
  const lang = DETECTED_LANGUAGE === 'he' ? 'עברית' : (DETECTED_LANGUAGE === 'en' ? 'English' : DETECTED_LANGUAGE);
  fullTranscriptEl.textContent = `🎤 [Groq Whisper - ${lang}]\n\n${WHISPER_TEXT}`;
}

ytSearchBtn.onclick = async () => {
  const query = ytSearchEl.value.trim();
  if (!query) return showYtStatus('הזן שם שיר', 'warn');
  showYtStatus('מחפש...', 'warn');
  ytResultsEl.style.display = 'none';
  try {
    const r = await fetch(`${SERVER}/api/yt?q=${encodeURIComponent(query)}`);
    const data = await r.json();
    if (!data || !data.length) return showYtStatus('לא נמצא', 'warn');
    displayYouTubeResults(data.map(v => ({
      videoId: v.id, title: v.title, author: v.author || v.channel, thumbnail: v.thumbnail
    })));
    ytStatusEl.style.display = 'none';
    ytResultsEl.style.display = 'block';
  } catch (e) {
    showYtStatus('שגיאה בחיפוש', 'err');
  }
};
ytSearchEl.onkeydown = (e) => { if(e.key === 'Enter') ytSearchBtn.click(); };

ytUrlBtn.onclick = async () => {
  const url = ytUrlEl.value.trim();
  if(!url) return showYtStatus('הזן קישור', 'warn');
  const videoId = extractYouTubeId(url);
  if(!videoId) return showYtStatus('קישור לא תקין', 'err');
  selectedYouTubeVideo = { id: videoId, title: 'YouTube Video', url: `https://www.youtube.com/watch?v=${videoId}` };
  showYtStatus('✓ נבחר', 'ok');
  ytResultsEl.style.display = 'none';
};

function extractYouTubeId(url) {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
    /^([a-zA-Z0-9_-]{11})$/
  ];
  for(const pattern of patterns) {
    const match = url.match(pattern);
    if(match) return match[1];
  }
  return null;
}

function showYtStatus(msg, type) {
  ytStatusEl.textContent = msg;
  ytStatusEl.className = `pill ${type}`;
  ytStatusEl.style.display = 'inline-flex';
}

function displayYouTubeResults(results) {
  ytResultsEl.innerHTML = '';
  results.forEach((video) => {
    if(!video.videoId) return;
    const div = document.createElement('div');
    div.className = 'yt-result';
    div.innerHTML = `
      <img class="thumb" src="${video.thumbnail}" alt="" />
      <div class="info">
        <div class="title">${escapeHtml(video.title || 'Unknown')}</div>
        <div class="channel">${escapeHtml(video.author || 'Unknown')}</div>
      </div>
    `;
    div.onclick = () => {
      document.querySelectorAll('.yt-result').forEach(r => r.classList.remove('selected'));
      div.classList.add('selected');
      selectedYouTubeVideo = { id: video.videoId, title: video.title, url: `https://www.youtube.com/watch?v=${video.videoId}` };
      ytUrlEl.value = selectedYouTubeVideo.url;
      showYtStatus('✓ נבחר', 'ok');
    };
    ytResultsEl.appendChild(div);
  });
}

function escapeHtml(text) { 
  const div = document.createElement('div'); 
  div.textContent = text; 
  return div.innerHTML; 
}

function showAnalyzing(stepText){ 
  statusEl.innerHTML='<span class="spin"></span> '+stepText; 
  statusEl.className='pill warn'; 
  statusEl.style.display='inline-flex'; 
}
function ok(msg){ 
  statusEl.textContent=msg; 
  statusEl.className='pill ok'; 
  statusEl.style.display='inline-flex'; 
}
function err(msg){ 
  errorEl.textContent=msg; 
  errorEl.style.display='inline-flex'; 
}
function hideAlerts(){ 
  statusEl.style.display='none'; 
  errorEl.style.display='none'; 
  gateChip.style.display='none'; 
}

function parseRoot(label){ 
  const m=label?.match?.(/^([A-G](?:#|b)?)/); 
  if(!m) return -1; 
  const nm=m[1].replace('b','#'); 
  return engine.NOTES_SHARP.indexOf(nm); 
}

function applyCapoToLabel(label, capo){
  capo = parseInt(capo);
  if(!capo || capo===0) return label;
  const m=label.match(/^([A-G](?:#|b)?)(.*)$/); 
  if(!m) return label;
  const idx=engine.NOTES_SHARP.indexOf(m[1].replace('b','#')); 
  if(idx<0) return label;
  // 🎸 Capo logic:
  // If detected chord is G and capo=3, show E (what you finger)
  // G (7) - 3 = E (4) ✓
  // 
  // If you want OPPOSITE (capo raises displayed chord):
  // Change to: idx + capo
  return engine.nameFlat(engine.toPc(idx - capo))+(m[2]||'');
}

function sanitizeLabel(lbl){ 
  if(!lbl) return lbl; 
  return lbl.replace(/[^A-Ga-g#bm79sus246()/\s+altdim]/g,'').trim(); 
}

analyzeBtn.onclick=async()=>{
  hideAlerts(); 
  aiBadge.style.display='none';
  ensembleBadge.style.display='none';
  liveChordEl.textContent='—'; 
  liveFunctionEl.textContent='—'; 
  liveLyricEl.textContent='—';
  liveSheetEl.textContent='—';
  LIVE_STREAM=[]; LIVE_POINTER=0;
  playBtn.disabled=true; 
  keyBadge.textContent='—'; 
  modeBadge.textContent='—';
  structuralCountEl.textContent='—'; 
  ornamentCountEl.textContent='—'; 
  secDomCountEl.textContent='—'; 
  modalBorrowCountEl.textContent='—';
  document.getElementById('confidenceStats').style.display='none';
  
  if(!WHISPER_TEXT) fullTranscriptEl.textContent = '⏳ ממתין...';

  let audioSource = null;
  if(currentTab === 'file') {
    const f=fileEl.files?.[0]; 
    if(!f){ err('בחר קובץ'); return; }
    audioSource = { type: 'file', data: f };
  } else {
    if(!selectedYouTubeVideo) { err('בחר סרטון'); return; }
    audioSource = { type: 'youtube', data: selectedYouTubeVideo };
  }

  try{
    showAnalyzing('שלב 1/6: טעינת אודיו');
    const st1 = await decodeAudio(audioSource);
    
    bpmEl.textContent = st1.bpm; 
    durEl.textContent = st1.duration.toFixed(1)+'s';
    if(st1.url) player.src = st1.url;

    showAnalyzing('שלב 2/6: מיצוי תכונות');
    const feats = engine.extractFeatures(st1, st1.bpm);

    showAnalyzing('שלב 3/6: זיהוי סולם');
    const key = engine.estimateKey(feats.chroma);
    const mode = engine.detectMode(feats, key);

    showAnalyzing('שלב 4/6: בנייה מבוססת בס');
    let timeline = engine.buildChordsFromBass(feats, key, st1.bpm);
      
      if(timeline.length === 0 || (timeline.length < 3 && st1.duration > 30)){
        const tonicLabel = engine.nameSharp(key.root) + (key.minor ? 'm' : '');
        timeline.unshift({
          t: 0,
          label: tonicLabel,
          fi: 0,
          endFrame: Math.min(10, feats.chroma.length),
          avgChroma: feats.chroma[0] || new Float32Array(12),
          ornamentType: 'structural',
          words: []
        });
      }

      showAnalyzing('שלב 5/6: הרחבות');
      const extMode = document.getElementById('extMode').value;
      const decMul = Number(decSensEl.value) || 1.0;
      timeline = engine.decorateQualitiesBassFirst(timeline, feats, key, extMode, decMul);
      
      const bassSens = Number(bassSensEl.value) || 1.25;
      timeline = engine.addInversionsIfNeeded(timeline, feats, bassSens);
      
      showAnalyzing('שלב 6/6: קוונטיזציה');
      timeline = engine.validateChords(timeline, key, feats);
      timeline = engine.classifyOrnamentsByDuration(timeline, st1.bpm);
      
      const quantValue = parseInt(document.getElementById('quant').value || '4', 10);
      timeline = engine.quantizeToGrid(timeline, st1.bpm, quantValue);
      timeline = engine.removeRedundantChords(timeline, st1.bpm);
      
      const gateFrame = engine.detectStartGate(feats);
      const gateTime = gateFrame * (feats.hop / feats.sr);

      window.__STATE = { 
        bpm: st1.bpm, 
        duration: st1.duration, 
        timeline: timeline, 
        key, 
        mode,
        gateTime: gateTime, 
        feats:{hop:feats.hop,sr:feats.sr} 
      };
    
    // Sanitize labels
    timeline = timeline.map(ev => ({ 
      ...ev, 
      label: sanitizeLabel(ev.label),
      words: ev.words || []
    }));
    window.__STATE.timeline = timeline;

    const capo=parseInt(capoEl.value||'0',10);
    keyBadge.textContent = applyCapoToLabel(engine.nameSharp(key.root)+(key.minor?'m':''), capo);
    modeBadge.textContent = mode;

    // Circle of Fifths
    const circleChords = engine.buildCircleOfFifths(key);
    const circleEl = document.getElementById('circleOfFifths');
    circleEl.innerHTML = circleChords.map(ch => {
      const displayLabel = applyCapoToLabel(ch.label, capo);
      return `<span class="tag" style="background:#1a2332;border-color:#38bdf8" title="${ch.function}">${displayLabel}</span>`;
    }).join('');

    // Analysis counts
    const structural = timeline.filter(e=>e.ornamentType==='structural').length;
    const ornaments = timeline.filter(e=>e.ornamentType!=='structural').length;
    
    let secDom = 0;
    for(let i=0; i<timeline.length-1; i++){
      if(timeline[i].label.includes('7') && !timeline[i].label.includes('maj7')){
        const rootI = parseRoot(timeline[i].label);
        const rootNext = parseRoot(timeline[i+1].label);
        if(rootI>=0 && rootNext>=0){
          const interval = engine.toPc(rootNext - rootI);
          if(interval === 5 || interval === 7) secDom++;
        }
      }
    }
    
    const diatonic = (key.minor? engine.MINOR_SCALE: engine.MAJOR_SCALE).map(s=>engine.toPc(key.root+s));
    let modalBorrow = 0;
    for(const ev of timeline){
      const r = parseRoot(ev.label);
      if(r>=0 && !diatonic.includes(r)) modalBorrow++;
    }
    
    structuralCountEl.textContent = structural;
    ornamentCountEl.textContent = ornaments;
    secDomCountEl.textContent = secDom;
    modalBorrowCountEl.textContent = modalBorrow;

    if(WHISPER_WORDS && WHISPER_WORDS.length > 0) {
      syncChordsWithLyrics();
      displayWhisperResult();
    }

    ok('✓ ניתוח הושלם');
    hookPlaybackLive(); 
    refreshSheetTabView();
    playBtn.disabled=false; 
    aiBadge.style.display='inline-flex';
  }catch(e){ 
    console.error(e); 
    err('שגיאה: '+e.message); 
  }
};

playBtn.onclick=async()=>{ 
  try{ await player.play(); } 
  catch(e){ alert('לחץ ▶️'); } 
};

async function decodeAudio(source){
  if(source.type === 'file') return await decodeAudioFile(source.data);
  else return await decodeYouTubeAudio(source.data);
}

async function decodeAudioFile(file){
  const AC = window.AudioContext || window.webkitAudioContext;
  const ctx = new AC(); 
  try{ await ctx.resume(); }catch{}
  const arr = await file.arrayBuffer();
  
  try{
    const buf = await ctx.decodeAudioData(arr.slice(0));
    return postDecode(buf, URL.createObjectURL(file));
  }catch(e1){
    try{
      const buf = await new Promise((resolve,reject)=>{ 
        ctx.decodeAudioData(arr.slice(0), b=>resolve(b), err=>reject(err)); 
      });
      return postDecode(buf, URL.createObjectURL(file));
    }catch(e2){ throw e2||e1; }
  }
  
  function postDecode(buf, url){
    const mono = (buf.numberOfChannels===1)? buf.getChannelData(0) : engine.mixStereo(buf);
    const sr0=buf.sampleRate, sr=22050;
    const x = engine.resampleLinear(mono, sr0, sr);
    const bpm = engine.estimateTempo(x, sr);
    return { 
      x, 
      sr, 
      bpm, 
      duration: x.length/sr, 
      url,
      audioBuffer: buf
    };
  }
}

async function decodeYouTubeAudio(video){
  showAnalyzing('מוריד שמע מיוטיוב...');
  try {
    const r = await fetch(`${SERVER}/api/youtube-download?videoId=${video.id}`);
    if (!r.ok) throw new Error(`Error: ${r.status}`);
    
    showAnalyzing('מעבד אודיו...');
    const audioBlob = await r.blob();
    const file = new File([audioBlob], 'audio.mp3', { type: 'audio/mpeg' });
    
    if (!WHISPER_RUNNING) {
      runWhisperInBackground(video.id);
    }
    
    return await decodeAudioFile(file);
  } catch (err) {
    console.error('YouTube audio error:', err);
    throw new Error('לא הצלחתי להוריד');
  }
}

function getHarmonicFunction(label, key){
  const rootPc = parseRoot(label); 
  if(rootPc<0) return '—';
  const rel = engine.toPc(rootPc - key.root);
  const scale = key.minor? engine.MINOR_SCALE : engine.MAJOR_SCALE;
  let bestDeg = null, bestDist=999;
  for(let d=0; d<scale.length; d++){
    const dist = Math.min((rel-scale[d]+12)%12,(scale[d]-rel+12)%12);
    if(dist<bestDist){ bestDist=dist; bestDeg=d; }
  }
  if(bestDeg===null) return '—';
  const funcNames = key.minor ? ['i','ii°','III','iv','v','VI','VII'] : ['I','ii','iii','IV','V','vi','vii°'];
  return funcNames[bestDeg] || '—';
}

function hookPlaybackLive(){
  const st=window.__STATE; 
  if(!st) return;
  const isRTL = DETECTED_LANGUAGE === 'he';
  liveSheetEl.className = `synced-sheet ${isRTL ? 'rtl' : 'ltr'}`;
  gateChip.style.display='inline-flex';
  LIVE_POINTER=0;
  
  buildFullLyricsSheet(isRTL);

  player.ontimeupdate=()=>{
    const t=player.currentTime;
    if(t < (st.gateTime || 0) + 0.3){ 
      liveChordEl.textContent='—'; 
      liveFunctionEl.textContent='—';
      liveLyricEl.textContent='—';
      return; 
    }
    if(gateChip.style.display!=='none') gateChip.style.display='none';

    let chordIdx=st.timeline.findIndex(x=>x.t>t);
    if(chordIdx===-1) chordIdx=st.timeline.length;
    const ev=st.timeline[chordIdx-1]||st.timeline[0];
    if(!ev) return;
    
    const capo=parseInt(capoEl.value||'0',10);
    const shown = sanitizeLabel(applyCapoToLabel(ev.label, capo));
    liveChordEl.textContent = shown;
    liveFunctionEl.textContent = getHarmonicFunction(ev.label, st.key);
    
    const currentWord = WHISPER_WORDS.find(w => t >= w.start && t < (w.end ?? (w.start+0.5)));
    if(currentWord) {
      liveLyricEl.textContent = currentWord.word || currentWord.text || '';
    } else {
      liveLyricEl.textContent = '—';
    }
    
    if(ev.ornamentType === 'structural'){
      structuralChip.style.display='inline-flex';
      ornamentChip.style.display='none';
    } else {
      structuralChip.style.display='none';
      ornamentChip.style.display='inline-flex';
    }

    addChordsProgressively(t, capo, isRTL);
  };

  resetSheetBtn.onclick=()=>{ 
    LIVE_POINTER=0; 
    buildFullLyricsSheet(isRTL);
  };
}

function buildFullLyricsSheet(isRTL) {
  liveSheetEl.innerHTML = '';
  
  if(!WHISPER_WORDS || WHISPER_WORDS.length === 0) {
    liveSheetEl.innerHTML = '<div style="color:#666">⏳ ממתין למילים...</div>';
    return;
  }
  
  let html = '<div class="lyrics-container">';
  let lineWords = [];
  
  WHISPER_WORDS.forEach((w, idx) => {
    const text = (w.word || w.text || '').trim();
    if(!text) return;
    
    lineWords.push({
      text: text,
      time: w.start,
      id: `word-${idx}`
    });
    
    const isEndOfSentence = /[.!?,؛،־]/.test(text);
    if(lineWords.length >= 10 || isEndOfSentence || idx === WHISPER_WORDS.length - 1) {
      html += '<div class="lyric-line-container">';
      lineWords.forEach(word => {
        html += `<span class="word-slot" data-time="${word.time}" id="${word.id}">
          <span class="chord-slot"></span>
          <span class="word-text">${escapeHtml(word.text)}</span>
        </span> `;
      });
      html += '</div>';
      lineWords = [];
    }
  });
  
  html += '</div>';
  liveSheetEl.innerHTML = html;
}

function addChordsProgressively(currentTime, capo, isRTL) {
  const st = window.__STATE;
  if(!st) return;
  
  st.timeline.forEach(ev => {
    if(ev.t > currentTime) return;
    if(ev._displayed) return;
    
    const chordLabel = sanitizeLabel(applyCapoToLabel(ev.label, capo));
    
    const wordSlots = liveSheetEl.querySelectorAll('.word-slot');
    let closestSlot = null;
    let minDiff = 0.2;
    
    wordSlots.forEach(slot => {
      const wordTime = parseFloat(slot.dataset.time);
      const diff = Math.abs(wordTime - ev.t);
      if(diff < minDiff) {
        minDiff = diff;
        closestSlot = slot;
      }
    });
    
    if(closestSlot) {
      const chordSlot = closestSlot.querySelector('.chord-slot');
      if(chordSlot && !chordSlot.textContent.trim()) {
        chordSlot.textContent = chordLabel;
        chordSlot.classList.add('active');
        setTimeout(() => chordSlot.classList.remove('active'), 500);
      }
    } else {
      let afterSlot = null;
      wordSlots.forEach(slot => {
        const wordTime = parseFloat(slot.dataset.time);
        if(wordTime > ev.t && !afterSlot) {
          afterSlot = slot;
        }
      });
      
      if(afterSlot) {
        const spacer = document.createElement('span');
        spacer.className = 'word-slot spacer';
        spacer.innerHTML = `
          <span class="chord-slot active">${chordLabel}</span>
          <span class="word-text">___</span>
        `;
        
        if(isRTL) {
          afterSlot.insertAdjacentElement('afterend', spacer);
        } else {
          afterSlot.insertAdjacentElement('beforebegin', spacer);
        }
        
        setTimeout(() => spacer.querySelector('.chord-slot').classList.remove('active'), 500);
      }
    }
    
    ev._displayed = true;
  });
}

function refreshSheetTabView(){
  SyncEngine.refreshSheetTabView(window.__STATE, WHISPER_WORDS, WHISPER_TEXT, DETECTED_LANGUAGE, capoEl.value, sanitizeLabel, applyCapoToLabel, fullSheetEl);
}

copyBtn.onclick = () => {
  const text = fullSheetEl.textContent;
  navigator.clipboard.writeText(text).then(() => {
    copyBtn.textContent = '✅ הועתק!';
    setTimeout(() => copyBtn.textContent = '📋 העתק דף', 1500);
  });
};

exportBtn.onclick=()=>{
  const text = fullSheetEl.textContent || '';
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = 'chords.txt'; 
  a.click(); 
  URL.revokeObjectURL(url);
};

// 🆕 Transpose functions
let transposeOffset = 0;

function transposeUp() {
  if(!window.__STATE) return;
  transposeOffset++;
  applyTranspose();
}

function transposeDown() {
  if(!window.__STATE) return;
  transposeOffset--;
  applyTranspose();
}

function applyTranspose() {
  const st = window.__STATE;
  if(!st) return;
  
  // Update key display
  const newRoot = engine.toPc(st.key.root + transposeOffset);
  const keyLabel = engine.nameSharp(newRoot) + (st.key.minor ? 'm' : '');
  const capo = parseInt(capoEl.value || '0', 10);
  keyBadge.textContent = applyCapoToLabel(keyLabel, capo);
  
  // Update all chord labels
  st.timeline.forEach(ev => {
    const originalRoot = parseRoot(ev.label);
    if(originalRoot < 0) return;
    
    const quality = ev.label.replace(/^[A-G](?:#|b)?/, '');
    const newChordRoot = engine.toPc(originalRoot + transposeOffset);
    const newLabel = engine.nameSharp(newChordRoot) + quality;
    
    // Store original if not already stored
    if(!ev._originalLabel) ev._originalLabel = ev.label;
    ev.label = newLabel;
  });
  
  // Refresh display
  refreshSheetTabView();
  
  // Update circle of fifths
  const circleChords = engine.buildCircleOfFifths({
    root: engine.toPc(st.key.root + transposeOffset),
    minor: st.key.minor
  });
  const circleEl = document.getElementById('circleOfFifths');
  circleEl.innerHTML = circleChords.map(ch => {
    const displayLabel = applyCapoToLabel(ch.label, capo);
    return `<span class="tag" style="background:#1a2332;border-color:#38bdf8" title="${ch.function}">${displayLabel}</span>`;
  }).join('');
  
  console.log(`🎵 Transposed ${transposeOffset > 0 ? '+' : ''}${transposeOffset} semitones`);
}

// 🆕 Toggle Major/Minor
function toggleMajorMinor() {
  const st = window.__STATE;
  if(!st) return;
  
  st.key.minor = !st.key.minor;
  
  // Update display
  const keyLabel = engine.nameSharp(st.key.root) + (st.key.minor ? 'm' : '');
  const capo = parseInt(capoEl.value || '0', 10);
  keyBadge.textContent = applyCapoToLabel(keyLabel, capo);
  
  // Update mode
  modeBadge.textContent = st.key.minor ? 'Natural Minor' : 'Major';
  
  // Rebuild circle of fifths
  const circleChords = engine.buildCircleOfFifths(st.key);
  const circleEl = document.getElementById('circleOfFifths');
  circleEl.innerHTML = circleChords.map(ch => {
    const displayLabel = applyCapoToLabel(ch.label, capo);
    return `<span class="tag" style="background:#1a2332;border-color:#38bdf8" title="${ch.function}">${displayLabel}</span>`;
  }).join('');
  
  console.log(`🔄 Toggled to ${st.key.minor ? 'Minor' : 'Major'}`);
}

console.log('✅ ChordFinder Pro loaded successfully!');

</script>

</body>
</html>
