<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChordFinderPro v29 ğŸ¸</title>
  <meta name="theme-color" content="#0b1022" />
  <style>
    :root{--bg:#0b1022;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--card:#0a1324;--border:#1b2333;--brand:#22c55e;--accent:#38bdf8;--alert:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);direction:rtl}
    .wrap{max-width:1200px;margin:auto;padding:18px}
    h1{margin:6px 0 10px;font-size:24px}
    .muted{color:var(--muted);font-size:14px}
    .panel{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"], select, button, input[type="number"], input[type="text"]{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;appearance:none;font-weight:700;cursor:pointer}
    input[type="text"]{width:100%;max-width:500px;font-weight:400}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1221;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px}
    .badge.ai{border-color:#23664d;background:#0d2e1f;color:#d7ffe6}
    .badge.pro{border-color:#664d23;background:#2e1f0d;color:#ffd7a3}
    .badge.whisper{border-color:#38bdf8;background:#0a1f2e;color:#bae6fd}
    .badge.sync{border-color:#8b5cf6;background:#2e1065;color:#e9d5ff}
    .live{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:18px;margin-top:10px}
    .live .title{color:#a9b4c8;font-size:13px}
    .live .ch{font-weight:800;font-size:42px}
    .live .func{font-size:14px;color:#38bdf8;margin-top:4px}
    .live .lyric{font-size:18px;color:#cbd5e1;margin-top:12px;font-style:italic;direction:rtl;line-height:1.6;background:#0a1324;padding:10px;border-radius:8px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3d55;margin:2px 4px;background:#0b1221}
    .ok{border-color:#1f5f3f;color:#d7ffe6;background:#0d2e1f}
    .err{border-color:#5f2323;color:#ffe0e0;background:#3f1d1d}
    .warn{border-color:#8a6a1f;color:#fff0d9;background:#3a2a0c}
    .spin{width:12px;height:12px;border-radius:50%;border:2px solid var(--accent);border-top-color:transparent;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#0b1221;border:1px solid #1f2a40;font-size:12px}
    .chip .dot{width:6px;height:6px;border-radius:50%;background:#22c55e}
    .chip.ornament{border-color:#8a6a1f;background:#2a2010}
    .chip.structural{border-color:#1f5f3f;background:#0d2e1f}
    .sliderRow{display:flex;align-items:center;gap:10px;margin-top:8px}
    input[type="range"]{width:220px}
    .tag{font-size:12px;color:#cbd5e1;border:1px solid #1f2a40;padding:4px 8px;border-radius:999px;background:#0b1221}
    .analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-top:12px}
    .analysis-card{background:#0b1221;border:1px solid #1f2a40;border-radius:12px;padding:12px}
    .analysis-card h3{margin:0 0 8px 0;font-size:14px;color:#38bdf8}
    .analysis-card .value{font-size:20px;font-weight:700;color:#22c55e}
    .yt-result{display:flex;gap:10px;padding:10px;border:1px solid #1f2a40;border-radius:10px;margin-top:8px;align-items:center;cursor:pointer;transition:all 0.2s}
    .yt-result:hover{background:#12203a;border-color:#38bdf8}
    .yt-result.selected{background:#164e3a;border-color:#22c55e}
    .yt-result img.thumb{width:120px;height:68px;object-fit:cover;border-radius:8px;flex-shrink:0}
    .yt-result .info{flex:1;min-width:0}
    .yt-result .title{font-weight:700;margin-bottom:4px;color:#e5e7eb;word-wrap:break-word;white-space:normal;line-height:1.3}
    .yt-result .channel{font-size:12px;color:#94a3b8}
    .yt-results{max-height:400px;overflow-y:auto}
    .tabs{display:flex;gap:4px;margin-bottom:12px}
    .tab{padding:8px 16px;border-radius:8px;background:#0b1221;border:1px solid #1f2a40;cursor:pointer;transition:all 0.2s}
    .tab.active{background:#0d2e1f;border-color:#22c55e;color:#d7ffe6}
    .tab:hover{border-color:#38bdf8}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .info-box{background:#1f2a40;padding:10px;border-radius:8px;margin-top:8px;font-size:13px;color:#cbd5e1}
    .info-box.success{background:#0d2e1f;border:1px solid #22c55e}
    .synced-sheet{background:#fff;color:#000;padding:20px;border-radius:8px;font-family:'Courier New',Courier,monospace;line-height:2.0;overflow-x:auto;max-width:100%}
    .synced-sheet.rtl{direction:rtl;text-align:right}
    .synced-sheet.ltr{direction:ltr;text-align:left}
    .chord-line{color:#2563eb;font-weight:700;font-size:14px;margin:0;white-space:pre-wrap;font-family:'Courier New',Courier,monospace;letter-spacing:0.5px}
    .lyric-line{color:#000;font-size:16px;margin:0 0 20px 0;white-space:pre-wrap;font-family:'Courier New',Courier,monospace}
    .synced-sheet.rtl .chord-line{text-align:right}
    .synced-sheet.rtl .lyric-line{text-align:right}
    .synced-sheet.ltr .chord-line{text-align:left}
    .synced-sheet.ltr .lyric-line{text-align:left}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸµ Chord Finder Pro v29 ğŸ¯
      <span class="badge pro">Professional</span>
      <span class="badge whisper">Groq Whisper</span>
      <span class="badge sync">×¡× ×›×¨×•×Ÿ ××“×•×™×§</span>
    </h1>
    <div class="muted">××§×•×¨×“×™× ××¢×œ ××™×œ×™× ×‘×–××Ÿ ×××ª + ×“×£ × ×’×™× ×” ××œ×. RTL/LTR ××•×˜×•××˜×™. Sync ××©×•×¤×¨ ×¢× 200ms window.</div>

    <section class="panel">
      <div class="tabs">
        <div class="tab active" data-tab="file">ğŸ“ ×§×•×‘×¥ ××§×•××™</div>
        <div class="tab" data-tab="youtube">ğŸ¬ ×™×•×˜×™×•×‘</div>
        <div class="tab" data-tab="sheet">ğŸ“ ×“×£ × ×’×™× ×”</div>
      </div>

      <div id="fileTab" class="tab-content active">
        <div class="row">
          <input id="file" type="file" accept="audio/*,video/*" />
        </div>
      </div>

      <div id="youtubeTab" class="tab-content">
        <div class="info-box success">
          âš¡ ×¡× ×›×¨×•×Ÿ ××“×•×™×§: ××§×•×¨×“ ×¢×œ ××™×œ×”/×‘×™×Ÿ ××™×œ×™× ×œ×¤×™ ×”×–××Ÿ ×”××“×•×™×§ (Â±200ms).
        </div>
        
        <div class="row" style="margin-top:12px">
          <input id="ytSearch" type="text" placeholder='×—×¤×© ×©×™×¨ (×œ××©×œ: "Leonard Cohen Hallelujah")' />
          <button id="ytSearchBtn">ğŸ” ×—×¤×©</button>
        </div>
        
        <div id="ytResults" class="yt-results" style="display:none"></div>
        
        <div style="margin-top:12px">
          <div style="margin-bottom:8px;font-weight:700">××• ×”×“×‘×§ ×§×™×©×•×¨ ×™×•×˜×™×•×‘:</div>
          <div class="row">
            <input id="ytUrl" type="text" placeholder="https://www.youtube.com/watch?v=..." style="flex:1" />
            <button id="ytUrlBtn">âœ“ ×”×©×ª××©</button>
          </div>
        </div>
        
        <div id="ytStatus" class="pill" style="display:none;margin-top:8px"></div>
        <div id="whisperStatus" class="pill warn" style="display:none;margin-top:8px">
          <span class="spin"></span> ğŸ¤ Groq Whisper ×¢×•×‘×“ ×‘×¨×§×¢...
        </div>
      </div>

      <div id="sheetTab" class="tab-content">
        <h3>ğŸ“‹ ×“×£ × ×’×™× ×” ××§×¦×•×¢×™</h3>
        <div id="fullSheet" class="synced-sheet">â€”</div>
        
        <h3 style="margin-top:16px">ğŸ¤ ×ª××œ×•×œ ××œ×</h3>
        <div id="fullTranscript" style="max-height:300px;overflow:auto;background:#0b1221;padding:12px;border-radius:8px;white-space:pre-wrap;font-family:Arial">â€”</div>
        
        <div class="row" style="margin-top:12px">
          <button id="exportBtn">ğŸ’¾ ×™×™×¦× ×œ-ChordPro</button>
          <button id="copyBtn">ğŸ“‹ ×”×¢×ª×§ ×“×£</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <label>××¦×‘ ×–×™×”×•×™:
          <select id="extMode">
            <option value="basic">×‘×¡×™×¡×™</option>
            <option value="jazz" selected>×’'××– (7/9/11/13)</option>
            <option value="pro">××§×¦×•×¢×™</option>
          </select>
        </label>
        <label>×§×•×•×× ×˜×”:
          <select id="quant">
            <option value="4" selected>1/4</option>
            <option value="8">1/8</option>
          </select>
        </label>
        <label>ğŸ¸ ×§××¤×•:
          <input id="capo" type="number" value="0" min="0" max="11" style="width:80px" />
        </label>
        <button id="analyzeBtn">× ×ª×—</button>
        <button id="playBtn" disabled>ğŸ§ ×”×¤×¢×œ</button>
        <button id="showDebugBtn" style="background:#f80;border-color:#f60">ğŸ› Debug</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge">BPM: <b id="bpm">â€”</b></span>
        <span class="badge">××©×š: <b id="dur">â€”</b></span>
        <span class="badge">×¡×•×œ×: <b id="keyBadge">â€”</b></span>
        <span class="badge">××¦×‘: <b id="modeBadge">â€”</b></span>
        <span id="aiBadge" class="badge ai" style="display:none">AI Enhanced</span>
      </div>

      <div id="status" class="pill ok" style="display:none"></div>
      <div id="error" class="pill err" style="display:none"></div>

      <div class="sliderRow">
        <span class="tag">Ã—<span id="bassMulTxt">1.25</span></span>
        <input id="bassSens" type="range" min="0.5" max="2.0" step="0.05" value="1.25" />
        <span style="color:#94a3b8;font-size:12px">×¨×’×™×©×•×ª ×‘×¡</span>
      </div>
      <div class="sliderRow">
        <span class="tag">Ã—<span id="decMulTxt">1.00</span></span>
        <input id="decSens" type="range" min="0.5" max="2.0" step="0.05" value="1.00" />
        <span style="color:#94a3b8;font-size:12px">×¨×’×™×©×•×ª ×”×¨×—×‘×•×ª</span>
      </div>

      <div class="row">
        <span id="gateChip" class="chip warn" style="display:none"><span class="dot"></span>××—×›×” ×œ×¤×¨×™×˜×”...</span>
      </div>
    </section>

    <section class="panel">
      <h2>× ×™×ª×•×— ×”×¨××•× ×™ ××ª×§×“×</h2>
      <div class="analysis-grid">
        <div class="analysis-card">
          <h3>××§×•×¨×“×™× ××‘× ×™×™×</h3>
          <div class="value" id="structuralCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>×§×™×©×•×˜×™×</h3>
          <div class="value" id="ornamentCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>×“×•××™× × ×˜ ××©× ×™</h3>
          <div class="value" id="secDomCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>×”×©××œ×•×ª ××•×“××œ×™×•×ª</h3>
          <div class="value" id="modalBorrowCount">â€”</div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>×ª×¦×•×’×” ×—×™×”</h2>
      <audio id="player" controls preload="auto" crossorigin="anonymous" style="width:100%"></audio>
      <div class="live">
        <div style="flex:1">
          <div class="title">×”××§×•×¨×“ ×›×¨×’×¢</div>
          <div class="ch" id="liveChord">â€”</div>
          <div class="func" id="liveFunction">â€”</div>
          <div class="lyric" id="liveLyric">â€”</div>
        </div>
        <div style="text-align:left">
          <span id="ornamentChip" class="chip ornament" style="display:none">×§×™×©×•×˜</span>
          <span id="structuralChip" class="chip structural" style="display:none">××‘× ×™</span>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>ğŸ“ ×“×£ × ×’×™× ×” â€” ×–××Ÿ ×××ª</h2>
      <div id="liveSheet" class="synced-sheet">â€”</div>
      <div class="row" style="margin-top:8px">
        <button id="resetSheet">××¤×¡ ×“×£</button>
      </div>
    </section>

    <section class="panel" id="debugPanel" style="display:none">
      <h2>ğŸ› Debug Info - Sync Analysis</h2>
      <div style="background:#1a1f2e;padding:12px;border-radius:8px;font-family:monospace;font-size:11px;max-height:400px;overflow:auto;direction:ltr;text-align:left">
        <div id="debugLog" style="color:#0f0"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="toggleDebug">×”×¡×ª×¨ Debug</button>
        <button id="clearDebug">× ×§×”</button>
      </div>
    </section>
  </div>

<script src="chord-engine.js"></script>
<script src="sync_engine_v2.js"></script>
<script>
window.addEventListener('load', function() {
console.log('ğŸ¸ ChordFinder Pro v29 - Sync Edition');

// Check ChordEngine
if(typeof ChordEngine === 'undefined') {
  alert('âŒ chord-engine.js ×œ× × ×˜×¢×Ÿ!');
  return;
}

const engine = new ChordEngine();
const SERVER = window.location.origin;

// State
let selectedYouTubeVideo = null;
let currentTab = 'file';
let WHISPER_SEGMENTS = [];
let WHISPER_WORDS = [];
let WHISPER_TEXT = '';
let WHISPER_RUNNING = false;
let DETECTED_LANGUAGE = 'en';
let LIVE_STREAM = [];
let LIVE_POINTER = 0;
let SYNC_STATS = {matched: 0, spacers: 0, total: 0};

// Elements
const fileEl = document.getElementById('file');
const analyzeBtn = document.getElementById('analyzeBtn');
const playBtn = document.getElementById('playBtn');
const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const whisperStatusEl = document.getElementById('whisperStatus');
const fullTranscriptEl = document.getElementById('fullTranscript');
const fullSheetEl = document.getElementById('fullSheet');
const gateChip = document.getElementById('gateChip');
const player = document.getElementById('player');
const bpmEl = document.getElementById('bpm');
const durEl = document.getElementById('dur');
const capoEl = document.getElementById('capo');
const keyBadge = document.getElementById('keyBadge');
const modeBadge = document.getElementById('modeBadge');
const liveChordEl = document.getElementById('liveChord');
const liveFunctionEl = document.getElementById('liveFunction');
const liveLyricEl = document.getElementById('liveLyric');
const liveSheetEl = document.getElementById('liveSheet');
const resetSheetBtn = document.getElementById('resetSheet');
const exportBtn = document.getElementById('exportBtn');
const copyBtn = document.getElementById('copyBtn');
const aiBadge = document.getElementById('aiBadge');
const bassSensEl = document.getElementById('bassSens');
const decSensEl = document.getElementById('decSens');
const bassMulTxt = document.getElementById('bassMulTxt');
const decMulTxt = document.getElementById('decMulTxt');
const structuralCountEl = document.getElementById('structuralCount');
const ornamentCountEl = document.getElementById('ornamentCount');
const secDomCountEl = document.getElementById('secDomCount');
const modalBorrowCountEl = document.getElementById('modalBorrowCount');
const ornamentChip = document.getElementById('ornamentChip');
const structuralChip = document.getElementById('structuralChip');
const ytSearchEl = document.getElementById('ytSearch');
const ytSearchBtn = document.getElementById('ytSearchBtn');
const ytResultsEl = document.getElementById('ytResults');
const ytStatusEl = document.getElementById('ytStatus');
const ytUrlEl = document.getElementById('ytUrl');
const ytUrlBtn = document.getElementById('ytUrlBtn');
const debugPanel = document.getElementById('debugPanel');
const debugLog = document.getElementById('debugLog');
const toggleDebugBtn = document.getElementById('toggleDebug');
const clearDebugBtn = document.getElementById('clearDebug');
const showDebugBtn = document.getElementById('showDebugBtn');

// Debug functions
function debugWrite(msg, color='#0f0'){
  console.log(msg);
  if(debugLog){
    const line = document.createElement('div');
    line.style.color = color;
    line.textContent = msg;
    debugLog.appendChild(line);
    debugLog.scrollTop = debugLog.scrollHeight;
  }
}

function debugClear(){
  if(debugLog) debugLog.innerHTML = '';
}

function showDebug(){
  if(debugPanel){
    debugPanel.style.display = 'block';
    toggleDebugBtn.textContent = '×”×¡×ª×¨ Debug';
  }
}

showDebugBtn.onclick = () => {
  showDebug();
  debugPanel.scrollIntoView({ behavior: 'smooth' });
};

toggleDebugBtn.onclick = () => {
  if(debugPanel.style.display === 'none'){
    debugPanel.style.display = 'block';
    toggleDebugBtn.textContent = '×”×¡×ª×¨ Debug';
  } else {
    debugPanel.style.display = 'none';
    toggleDebugBtn.textContent = '×”×¦×’ Debug';
  }
};

clearDebugBtn.onclick = debugClear;

bassSensEl.oninput = () => bassMulTxt.textContent = Number(bassSensEl.value).toFixed(2);
decSensEl.oninput = () => decMulTxt.textContent = Number(decSensEl.value).toFixed(2);

// Tabs
function initTabs() {
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.getAttribute('data-tab');
      currentTab = tabName;
      tabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      tabContents.forEach(content => content.classList.remove('active'));
      const targetContent = document.getElementById(tabName + 'Tab');
      if(targetContent) targetContent.classList.add('active');
      if(tabName === 'sheet') refreshSheetTabView();
    });
  });
}
initTabs();

// Whisper
async function runWhisperInBackground(videoId) {
  if(WHISPER_RUNNING) return;
  WHISPER_RUNNING = true;
  whisperStatusEl.style.display = 'inline-flex';
  whisperStatusEl.textContent = 'â³ Groq Whisper...';
  try {
    const r = await fetch(`${SERVER}/api/groq-transcribe`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ videoId: videoId })
    });
    if(!r.ok) throw new Error(`Failed: ${r.status}`);
    const data = await r.json();
    if(data.success) {
      WHISPER_SEGMENTS = data.segments || [];
      WHISPER_WORDS = data.words || [];
      WHISPER_TEXT = data.text || '';
      DETECTED_LANGUAGE = data.language || 'en';
      whisperStatusEl.textContent = 'âœ“ Groq Whisper';
      whisperStatusEl.classList.remove('warn');
      whisperStatusEl.classList.add('ok');
      if(window.__STATE && window.__STATE.timeline) {
        syncChordsWithLyrics();
        refreshSheetTabView();
      }
      setTimeout(() => whisperStatusEl.style.display = 'none', 2500);
    } else {
      throw new Error(data.error || 'Failed');
    }
  } catch(e) {
    console.error('Error:', e);
    whisperStatusEl.textContent = 'âŒ ×©×’×™××”';
    whisperStatusEl.classList.add('err');
    setTimeout(() => whisperStatusEl.style.display = 'none', 4000);
  } finally {
    WHISPER_RUNNING = false;
  }
}

// Sync chords with lyrics
function syncChordsWithLyrics(){
  if(!window.__STATE || !WHISPER_WORDS || WHISPER_WORDS.length === 0) return;
  
  const tl = window.__STATE.timeline;
  const words = WHISPER_WORDS;
  LIVE_STREAM = [];
  
  const capo = parseInt(capoEl.value || '0', 10);
  
  // ğŸ¯ CRITICAL: Add gateTime offset to all Whisper timestamps!
  const gateOffset = window.__STATE.gateTime || 0;
  
  debugWrite(`ğŸ¯ Gate offset: ${gateOffset.toFixed(2)}s`, '#f0f');
  
  for(const w of words){
    const start = w.start + gateOffset; // â† ADD OFFSET HERE!
    const end = (w.end ?? (w.start + 0.1)) + gateOffset;
    const near = tl.find(ch => ch.t >= start-0.05 && ch.t <= end+0.05);
    LIVE_STREAM.push({
      start, 
      text: (w.word || w.text || ''), 
      chordLabel: near ? applyCapoToLabel(engine.sanitizeLabel(near.label), capo) : null, 
      isSpacer: false
    });
  }
  
  for(const ch of tl){
    const t = ch.t;
    // Check with offset timestamps
    const hasWord = words.some(w => {
      const wStart = w.start + gateOffset;
      const wEnd = (w.end ?? (w.start + 0.1)) + gateOffset;
      return t >= (wStart - 0.05) && t <= (wEnd + 0.05);
    });
    if(!hasWord){
      LIVE_STREAM.push({
        start: t, 
        text: '', 
        chordLabel: applyCapoToLabel(engine.sanitizeLabel(ch.label), capo), 
        isSpacer: true
      });
    }
  }
  
  LIVE_STREAM.sort((a,b) => a.start - b.start);
  LIVE_POINTER = 0;
  
  tl.forEach((ch, i) => {
    const nextT = tl[i+1]?.t ?? (ch.t + 10);
    const bucket = words.filter(w => w.start >= ch.t && w.start < nextT);
    ch.words = bucket.map(w => (w.word || w.text || '').trim());
  });
}

function displayWhisperResult() {
  if(!WHISPER_TEXT || WHISPER_TEXT.trim() === '') {
    fullTranscriptEl.textContent = 'ğŸ’¬ ×ª××œ×•×œ ×œ× ×–××™×Ÿ';
    return;
  }
  const lang = DETECTED_LANGUAGE === 'he' ? '×¢×‘×¨×™×ª' : (DETECTED_LANGUAGE === 'en' ? 'English' : DETECTED_LANGUAGE);
  fullTranscriptEl.textContent = `ğŸ¤ [Groq Whisper - ${lang}]\n\n${WHISPER_TEXT}`;
}

// YouTube search
ytSearchBtn.onclick = async () => {
  const query = ytSearchEl.value.trim();
  if(!query) return showYtStatus('×”×–×Ÿ ×©× ×©×™×¨', 'warn');
  showYtStatus('××—×¤×©...', 'warn');
  ytResultsEl.style.display = 'none';
  try {
    const r = await fetch(`${SERVER}/api/yt?q=${encodeURIComponent(query)}`);
    const data = await r.json();
    if(!data || !data.length) return showYtStatus('×œ× × ××¦×', 'warn');
    displayYouTubeResults(data.map(v => ({
      videoId: v.id, title: v.title, author: v.author || v.channel, thumbnail: v.thumbnail
    })));
    ytStatusEl.style.display = 'none';
    ytResultsEl.style.display = 'block';
  } catch(e) {
    showYtStatus('×©×’×™××” ×‘×—×™×¤×•×©', 'err');
  }
};
ytSearchEl.onkeydown = (e) => { if(e.key === 'Enter') ytSearchBtn.click(); };

ytUrlBtn.onclick = async () => {
  const url = ytUrlEl.value.trim();
  if(!url) return showYtStatus('×”×–×Ÿ ×§×™×©×•×¨', 'warn');
  const videoId = extractYouTubeId(url);
  if(!videoId) return showYtStatus('×§×™×©×•×¨ ×œ× ×ª×§×™×Ÿ', 'err');
  selectedYouTubeVideo = { id: videoId, title: 'YouTube Video', url: `https://www.youtube.com/watch?v=${videoId}` };
  showYtStatus('âœ“ × ×‘×—×¨', 'ok');
  ytResultsEl.style.display = 'none';
};

function extractYouTubeId(url) {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
    /^([a-zA-Z0-9_-]{11})$/
  ];
  for(const pattern of patterns) {
    const match = url.match(pattern);
    if(match) return match[1];
  }
  return null;
}

function showYtStatus(msg, type) {
  ytStatusEl.textContent = msg;
  ytStatusEl.className = `pill ${type}`;
  ytStatusEl.style.display = 'inline-flex';
}

function displayYouTubeResults(results) {
  ytResultsEl.innerHTML = '';
  results.forEach((video) => {
    if(!video.videoId) return;
    const div = document.createElement('div');
    div.className = 'yt-result';
    div.innerHTML = `
      <img class="thumb" src="${video.thumbnail}" alt="" />
      <div class="info">
        <div class="title">${escapeHtml(video.title || 'Unknown')}</div>
        <div class="channel">${escapeHtml(video.author || 'Unknown')}</div>
      </div>
    `;
    div.onclick = () => {
      document.querySelectorAll('.yt-result').forEach(r => r.classList.remove('selected'));
      div.classList.add('selected');
      selectedYouTubeVideo = { id: video.videoId, title: video.title, url: `https://www.youtube.com/watch?v=${video.videoId}` };
      ytUrlEl.value = selectedYouTubeVideo.url;
      showYtStatus('âœ“ × ×‘×—×¨', 'ok');
    };
    ytResultsEl.appendChild(div);
  });
}

function escapeHtml(text) { 
  const div = document.createElement('div'); 
  div.textContent = text; 
  return div.innerHTML; 
}

// UI helpers
function showAnalyzing(stepText){ 
  statusEl.innerHTML = '<span class="spin"></span> ' + stepText; 
  statusEl.className = 'pill warn'; 
  statusEl.style.display = 'inline-flex'; 
}

function ok(msg){ 
  statusEl.textContent = msg; 
  statusEl.className = 'pill ok'; 
  statusEl.style.display = 'inline-flex'; 
}

function err(msg){ 
  errorEl.textContent = msg; 
  errorEl.style.display = 'inline-flex'; 
}

function hideAlerts(){ 
  statusEl.style.display = 'none'; 
  errorEl.style.display = 'none'; 
  gateChip.style.display = 'none'; 
}

function applyCapoToLabel(label, capo){
  if(!capo || capo === 0) return label;
  const m = label.match(/^([A-G](?:#|b)?)(.*)$/); 
  if(!m) return label;
  const idx = engine.NOTES_SHARP.indexOf(m[1].replace('b','#')); 
  if(idx < 0) return label;
  return engine.nameFlat(engine.toPc(idx - capo)) + (m[2] || '');
}

// Analyze button
analyzeBtn.onclick = async () => {
  hideAlerts(); 
  aiBadge.style.display = 'none';
  liveChordEl.textContent = 'â€”'; 
  liveFunctionEl.textContent = 'â€”'; 
  liveLyricEl.textContent = 'â€”';
  liveSheetEl.textContent = 'â€”';
  LIVE_STREAM = []; 
  LIVE_POINTER = 0;
  SYNC_STATS = {matched: 0, spacers: 0, total: 0};
  playBtn.disabled = true; 
  keyBadge.textContent = 'â€”'; 
  modeBadge.textContent = 'â€”';
  structuralCountEl.textContent = 'â€”'; 
  ornamentCountEl.textContent = 'â€”'; 
  secDomCountEl.textContent = 'â€”'; 
  modalBorrowCountEl.textContent = 'â€”';
  
  if(!WHISPER_TEXT) fullTranscriptEl.textContent = 'â³ ×××ª×™×Ÿ...';
  
  let audioSource = null;
  if(currentTab === 'file') {
    const f = fileEl.files?.[0]; 
    if(!f){ err('×‘×—×¨ ×§×•×‘×¥'); return; }
    audioSource = { type: 'file', data: f };
  } else {
    if(!selectedYouTubeVideo) { err('×‘×—×¨ ×¡×¨×˜×•×Ÿ'); return; }
    audioSource = { type: 'youtube', data: selectedYouTubeVideo };
  }
  
  try {
    showAnalyzing('×˜×•×¢×Ÿ ××•×“×™×•...');
    const audioBuffer = await decodeAudio(audioSource);
    
    if(audioBuffer.url) player.src = audioBuffer.url;
    
    showAnalyzing('×× ×ª×—...');
    const config = {
      extMode: document.getElementById('extMode').value,
      decSens: Number(decSensEl.value) || 1.0,
      bassSens: Number(bassSensEl.value) || 1.25,
      quantValue: parseInt(document.getElementById('quant').value || '4', 10)
    };
    
    const result = engine.analyze(audioBuffer.buffer, config);
    
    bpmEl.textContent = result.bpm; 
    durEl.textContent = result.duration.toFixed(1) + 's';
    
    const capo = parseInt(capoEl.value || '0', 10);
    keyBadge.textContent = applyCapoToLabel(engine.nameSharp(result.key.root) + (result.key.minor ? 'm' : ''), capo);
    modeBadge.textContent = result.mode;
    
    structuralCountEl.textContent = result.metrics.structural;
    ornamentCountEl.textContent = result.metrics.ornaments;
    secDomCountEl.textContent = result.metrics.secDom;
    modalBorrowCountEl.textContent = result.metrics.modalBorrow;
    
    window.__STATE = result;
    
    if(WHISPER_WORDS && WHISPER_WORDS.length > 0) {
      syncChordsWithLyrics();
      displayWhisperResult();
    }
    
    ok('âœ“ × ×™×ª×•×— ×”×•×©×œ×');
    hookPlaybackLive(); 
    refreshSheetTabView();
    playBtn.disabled = false; 
    aiBadge.style.display = 'inline-flex';
  } catch(e){ 
    console.error(e); 
    err('×©×’×™××”: ' + e.message); 
  }
};

playBtn.onclick = async () => { 
  try { await player.play(); } 
  catch(e) { alert('×œ×—×¥ â–¶ï¸'); } 
};

// Decode audio
async function decodeAudio(source){
  if(source.type === 'file') return await decodeAudioFile(source.data);
  else return await decodeYouTubeAudio(source.data);
}

async function decodeAudioFile(file){
  const AC = window.AudioContext || window.webkitAudioContext;
  const ctx = new AC(); 
  try { await ctx.resume(); } catch {}
  const arr = await file.arrayBuffer();
  
  try {
    const buf = await ctx.decodeAudioData(arr.slice(0));
    return { buffer: buf, url: URL.createObjectURL(file) };
  } catch(e1) {
    try {
      const buf = await new Promise((resolve, reject) => { 
        ctx.decodeAudioData(arr.slice(0), b => resolve(b), err => reject(err)); 
      });
      return { buffer: buf, url: URL.createObjectURL(file) };
    } catch(e2) { 
      throw e2 || e1; 
    }
  }
}

async function decodeYouTubeAudio(video){
  showAnalyzing('××•×¨×™×“ ××™×•×˜×™×•×‘...');
  try {
    const r = await fetch(`${SERVER}/api/youtube-download?videoId=${video.id}`);
    if(!r.ok) throw new Error(`Error: ${r.status}`);
    
    showAnalyzing('××¢×‘×“ ××•×“×™×•...');
    const audioBlob = await r.blob();
    const file = new File([audioBlob], 'audio.mp3', { type: 'audio/mpeg' });
    
    if(!WHISPER_RUNNING) {
      runWhisperInBackground(video.id);
    }
    
    return await decodeAudioFile(file);
  } catch(err) {
    console.error('YouTube audio error:', err);
    throw new Error('×œ× ×”×¦×œ×—×ª×™ ×œ×”×•×¨×™×“');
  }
}

// Get harmonic function
function getHarmonicFunction(label, key){
  const rootPc = engine.parseRoot(label); 
  if(rootPc < 0) return 'â€”';
  const rel = engine.toPc(rootPc - key.root);
  const scale = key.minor ? engine.MINOR_SCALE : engine.MAJOR_SCALE;
  let bestDeg = null, bestDist = 999;
  for(let d=0; d<scale.length; d++){
    const dist = Math.min((rel - scale[d] + 12) % 12, (scale[d] - rel + 12) % 12);
    if(dist < bestDist){ bestDist = dist; bestDeg = d; }
  }
  if(bestDeg === null) return 'â€”';
  const funcNames = key.minor ? ['i','iiÂ°','III','iv','v','VI','VII'] : ['I','ii','iii','IV','V','vi','viiÂ°'];
  return funcNames[bestDeg] || 'â€”';
}

// Hook playback
function hookPlaybackLive(){
  const st = window.__STATE; 
  if(!st) return;
  const isRTL = DETECTED_LANGUAGE === 'he';
  liveSheetEl.className = `synced-sheet ${isRTL ? 'rtl' : 'ltr'}`;
  gateChip.style.display = 'inline-flex';
  LIVE_POINTER = 0; 
  liveSheetEl.innerHTML = '';
  
  player.ontimeupdate = () => {
    const t = player.currentTime;
    if(t < st.gateTime + 0.3){ 
      liveChordEl.textContent = 'â€”'; 
      liveFunctionEl.textContent = 'â€”';
      liveLyricEl.textContent = 'â€”';
      return; 
    }
    if(gateChip.style.display !== 'none') gateChip.style.display = 'none';
    
    let chordIdx = st.timeline.findIndex(x => x.t > t);
    if(chordIdx === -1) chordIdx = st.timeline.length;
    const ev = st.timeline[chordIdx-1] || st.timeline[0];
    if(!ev) return;
    
    const capo = parseInt(capoEl.value || '0', 10);
    const shown = engine.sanitizeLabel(applyCapoToLabel(ev.label, capo));
    liveChordEl.textContent = shown;
    liveFunctionEl.textContent = getHarmonicFunction(ev.label, st.key);
    
    const currentWord = WHISPER_WORDS.find(w => {
      const wStart = w.start + (window.__STATE.gateTime || 0);
      const wEnd = (w.end ?? (w.start + 0.5)) + (window.__STATE.gateTime || 0);
      return t >= wStart && t < wEnd;
    });
    if(currentWord) {
      liveLyricEl.textContent = currentWord.word || currentWord.text || '';
    } else {
      liveLyricEl.textContent = 'â€”';
    }
    
    if(ev.ornamentType === 'structural'){
      structuralChip.style.display = 'inline-flex';
      ornamentChip.style.display = 'none';
    } else {
      structuralChip.style.display = 'none';
      ornamentChip.style.display = 'inline-flex';
    }
    
    while(LIVE_POINTER < LIVE_STREAM.length && LIVE_STREAM[LIVE_POINTER].start <= t){
      const it = LIVE_STREAM[LIVE_POINTER++];
      if(it.isSpacer){
        liveSheetEl.insertAdjacentHTML('beforeend',
          `<span class="spacer"><span class="chord">${it.chordLabel || ''}</span><span class="word">___</span></span> `);
      } else {
        const chHtml = it.chordLabel ? `<span class="chord">${it.chordLabel}</span>` : '';
        liveSheetEl.insertAdjacentHTML('beforeend',
          `<span class="chord-word">${chHtml}<span class="word">${escapeHtml(it.text || '')}</span></span> `);
      }
      if(/[.!?,Ø›ØŒÖ¾â€“]/.test((it.text || '').slice(-1)) || liveSheetEl.textContent.length % 90 < 2){
        liveSheetEl.insertAdjacentHTML('beforeend', '<br>');
      }
    }
  };
  
  resetSheetBtn.onclick = () => { LIVE_POINTER = 0; liveSheetEl.innerHTML = ''; };
}

// Copy/Export
copyBtn.onclick = () => {
  const text = fullSheetEl.textContent;
  navigator.clipboard.writeText(text).then(() => {
    copyBtn.textContent = 'âœ… ×”×•×¢×ª×§!';
    setTimeout(() => copyBtn.textContent = 'ğŸ“‹ ×”×¢×ª×§ ×“×£', 1500);
  });
};

exportBtn.onclick = () => {
  const text = fullSheetEl.textContent || '';
  const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = 'chords.txt'; 
  a.click(); 
  URL.revokeObjectURL(url);
};

// ğŸ¯ Refresh Sheet Tab - Beat-based Timeline
function refreshSheetTabView(){
  const st = window.__STATE;
  if(!st){ 
    if(fullSheetEl) fullSheetEl.textContent = '×œ×—×¥ "× ×ª×—"'; 
    return; 
  }
  
  const capo = parseInt(capoEl.value || '0', 10);
  const isRTL = DETECTED_LANGUAGE === 'he';
  
  fullSheetEl.className = `synced-sheet ${isRTL ? 'rtl' : 'ltr'}`;
  
  SYNC_STATS = {matched: 0, spacers: 0, total: 0};
  
  if(!WHISPER_WORDS || WHISPER_WORDS.length === 0) {
    let output = '<div style="color:#000;font-family:Arial">ğŸ¸ ××§×•×¨×“×™×:<br><br>';
    st.timeline.forEach((ev, i) => {
      const chord = applyCapoToLabel(ev.label, capo);
      output += `${chord}  `;
      if((i + 1) % 8 === 0) output += '<br>';
    });
    output += '<br><br>ğŸ’¡ ×œ×¡× ×›×¨×•×Ÿ ××™×œ×™× ×¦×¨×™×š Groq Whisper</div>';
    fullSheetEl.innerHTML = output;
    return;
  }
  
  syncChordsWithLyrics();
  displayWhisperResult();
  
  const words = WHISPER_WORDS;
  const tl = st.timeline;
  const gateOffset = st.gateTime || 0;
  
  debugWrite(`ğŸ¤ Whisper Words: ${words.length}`, '#ff0');
  debugWrite(`ğŸ¸ Chords: ${tl.length}`, '#0ff');
  debugWrite(`ğŸ¯ Gate Offset: ${gateOffset.toFixed(2)}s`, '#f0f');
  debugWrite(`ğŸ¼ Using Beat-based Timeline`, '#0f0');
  showDebug();
  
  // Apply capo to all chords
  const chordsWithCapo = tl.map(ch => ({
    ...ch,
    label: applyCapoToLabel(engine.sanitizeLabel(ch.label), capo)
  }));
  
  // Build beat-based timeline
  const lines = buildBeatTimeline(
    words, 
    chordsWithCapo, 
    st.bpm, 
    st.timeSignature || {numerator: 4, denominator: 4},
    isRTL, 
    gateOffset
  );
  
  // Render to HTML
  const html = renderBeatTimeline(lines, isRTL);
  
  // Stats
  const totalBeats = lines.reduce((sum, line) => sum + line.beats.length, 0);
  const beatsWithChords = lines.reduce((sum, line) => 
    sum + line.beats.filter(b => b.chord).length, 0);
  const beatsWithWords = lines.reduce((sum, line) => 
    sum + line.beats.filter(b => b.word).length, 0);
  
  const statsHtml = `<div style="margin-top:20px;padding:10px;background:#f0f8ff;border:1px solid #38bdf8;border-radius:8px;font-size:12px;color:#000">`;
  const finalHtml = html + statsHtml + 
    `ğŸ¼ Total beats: ${totalBeats} | ` +
    `ğŸ¸ Beats with chords: ${beatsWithChords} | ` +
    `ğŸ¤ Beats with words: ${beatsWithWords}` +
    `</div>`;
  
  fullSheetEl.innerHTML = finalHtml || '<div style="color:#999">××™×Ÿ ×ª×•×¦××•×ª</div>';
  
  debugWrite(`ğŸ“Š Lines: ${lines.length}, Beats: ${totalBeats}`, '#0f0');
}

console.log('âœ… ChordFinder Pro v29 loaded!');

}); // end window.load
</script>

</body>
</html>
