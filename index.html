<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ChordFinderPro v14.36 ğŸµ Ultimate Minor Detection [DEBUG]</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="ğŸµ ×–×™×”×•×™ ××§×•×¨×“×™× ××ª×§×“× ×¢× AI - ×ª××™×›×” ×‘-YouTube, inversions, extensions, ××•×“×•×œ×¦×™×•×ª ×•×¡× ×›×¨×•×Ÿ lyrics" />
  <meta name="theme-color" content="#38bdf8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ChordFinder Pro" />
  <meta name="mobile-web-app-capable" content="yes" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon512.png" />
  <link rel="apple-touch-icon" href="icon192.png" />
  
  <style>
    :root{--bg:#0b1022;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--card:#0a1324;--border:#1b2333;--brand:#22c55e;--accent:#38bdf8;--alert:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);direction:rtl}
    .wrap{max-width:1200px;margin:auto;padding:18px;padding-bottom:80px}
    h1{margin:6px 0 10px;font-size:24px}
    .muted{color:var(--muted);font-size:14px}
    .panel{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"], select, button, input[type="number"], input[type="text"]{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;appearance:none;font-weight:700;cursor:pointer}
    input[type="text"]{width:100%;max-width:500px;font-weight:400}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1221;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px}
    .badge.pro{border-color:#664d23;background:#2e1f0d;color:#ffd7a3}
    .badge.whisper{border-color:#38bdf8;background:#0a1f2e;color:#bae6fd}
    .live{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:18px;margin-top:10px}
    .live .title{color:#a9b4c8;font-size:13px}
    .live .ch{font-weight:800;font-size:42px}
    .live .func{font-size:14px;color:#38bdf8;margin-top:4px}
    .live .lyric{font-size:18px;color:#cbd5e1;margin-top:12px;font-style:italic;direction:rtl;line-height:1.6;background:#0a1324;padding:10px;border-radius:8px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3d55;margin:2px 4px;background:#0b1221}
    .ok{border-color:#1f5f3f;color:#d7ffe6;background:#0d2e1f}
    .err{border-color:#5f2323;color:#ffe0e0;background:#3f1d1d}
    .warn{border-color:#8a6a1f;color:#fff0d9;background:#3a2a0c}
    .spin{width:12px;height:12px;border-radius:50%;border:2px solid var(--accent);border-top-color:transparent;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#0b1221;border:1px solid #1f2a40;font-size:12px}
    .chip .dot{width:6px;height:6px;border-radius:50%;background:#22c55e}
    .chip.ornament{border-color:#8a6a1f;background:#2a2010}
    .chip.structural{border-color:#1f5f3f;background:#0d2e1f}
    .analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-top:12px}
    .analysis-card{background:#0b1221;border:1px solid #1f2a40;border-radius:12px;padding:12px}
    .analysis-card h3{margin:0 0 8px 0;font-size:14px;color:#38bdf8}
    .analysis-card .value{font-size:20px;font-weight:700;color:#22c55e}
    .yt-result{display:flex;gap:10px;padding:10px;border:1px solid #1f2a40;border-radius:10px;margin-top:8px;align-items:center;cursor:pointer;transition:all 0.2s}
    .yt-result:hover{background:#12203a;border-color:#38bdf8}
    .yt-result.selected{background:#164e3a;border-color:#22c55e}
    .yt-result img.thumb{width:120px;height:68px;object-fit:cover;border-radius:8px;flex-shrink:0}
    .yt-result .info{flex:1;min-width:0}
    .yt-result .title{font-weight:700;margin-bottom:4px;color:#e5e7eb;word-wrap:break-word;white-space:normal;line-height:1.3}
    .yt-result .channel{font-size:12px;color:#94a3b8}
    .yt-results{max-height:400px;overflow-y:auto}
    .tabs{display:flex;gap:4px;margin-bottom:12px}
    .tab{padding:8px 16px;border-radius:8px;background:#0b1221;border:1px solid #1f2a40;cursor:pointer;transition:all 0.2s}
    .tab.active{background:#0d2e1f;border-color:#22c55e;color:#d7ffe6}
    .tab:hover{border-color:#38bdf8}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .info-box{background:#1f2a40;padding:10px;border-radius:8px;margin-top:8px;font-size:13px;color:#cbd5e1}
    .info-box.success{background:#0d2e1f;border:1px solid #22c55e}
    .synced-sheet{background:#0a1324;color:#e5e7eb;padding:24px;border-radius:12px;font-family:'Courier New',Courier,monospace;line-height:1.8;overflow-x:auto;max-width:100%;white-space:pre;border:1px solid #1f2a40}
    .synced-sheet.rtl{direction:rtl;text-align:right}
    .synced-sheet.ltr{direction:ltr;text-align:left}
    .lyrics-container{display:block;width:100%;background:#0a1324;padding:20px;border-radius:12px;border:1px solid #1f2a40;max-height:500px;overflow-y:auto;overflow-x:auto;scroll-behavior:smooth}
    .sliderRow{display:flex;gap:10px;align-items:center;margin-top:8px}
    .sliderRow input[type="range"]{flex:1;max-width:200px}
    .sliderRow .tag{background:#1a2332;border:1px solid #38bdf8;padding:4px 8px;border-radius:8px;font-size:12px;min-width:45px;text-align:center}
  </style>
</head>
<body>

  <div class="wrap">
    <h1>Chord Finder Pro v14.36 [DEBUG]
      <span class="badge pro">Ultimate Minor Detection</span>
      <span class="badge whisper">Groq Whisper</span>
    </h1>
    <div class="muted">
      ××§×•×¨×“×™× ××¢×œ ××™×œ×™× ×‘×–××Ÿ ×××ª + ×“×£ × ×’×™× ×” ××œ×. RTL/LTR ××•×˜×•××˜×™.<br>
      <small style="opacity:0.7;font-size:11px">
        Powered by <strong>Groq Whisper</strong> â€¢ 
        Harmonic Theory Enhanced â€¢ 
        Built by <strong>Alon</strong>
      </small>
    </div>

    <section class="panel">
      <div class="tabs">
        <div class="tab active" data-tab="file">ğŸ“ ×§×•×‘×¥ ××§×•××™</div>
        <div class="tab" data-tab="youtube">ğŸ¬ ×™×•×˜×™×•×‘</div>
        <div class="tab" data-tab="sheet">ğŸ“ ×“×£ × ×’×™× ×”</div>
      </div>

      <div id="fileTab" class="tab-content active">
        <div class="row">
          <input id="file" type="file" accept="audio/*,video/*" />
        </div>
      </div>

      <div id="youtubeTab" class="tab-content">
        <div class="info-box success">
          âš¡ ×¡× ×›×¨×•×Ÿ ××“×•×™×§: ××§×•×¨×“ ×¢×œ ××™×œ×”/×‘×™×Ÿ ××™×œ×™× ×œ×¤×™ ×”×–××Ÿ ×”××“×•×™×§.
        </div>
        
        <div class="row" style="margin-top:12px">
          <input id="ytSearch" type="text" placeholder='×—×¤×© ×©×™×¨ (×œ××©×œ: "Leonard Cohen Hallelujah")' />
          <button id="ytSearchBtn">ğŸ” ×—×¤×©</button>
        </div>
        
        <div id="ytResults" class="yt-results" style="display:none"></div>
        
        <div style="margin-top:12px">
          <div style="margin-bottom:8px;font-weight:700">××• ×”×“×‘×§ ×§×™×©×•×¨ ×™×•×˜×™×•×‘:</div>
          <div class="row">
            <input id="ytUrl" type="text" placeholder="https://www.youtube.com/watch?v=..." style="flex:1" />
            <button id="ytUrlBtn">âœ… ×”×©×ª××©</button>
          </div>
        </div>
        
        <div id="ytStatus" class="pill" style="display:none;margin-top:8px"></div>
        <div id="whisperStatus" class="pill warn" style="display:none;margin-top:8px">
          <span class="spin"></span> ğŸ™ï¸ Groq Whisper ×¢×•×‘×“ ×‘×¨×§×¢...
        </div>
      </div>

      <div id="sheetTab" class="tab-content">
        <h3>ğŸ“„ ×“×£ × ×’×™× ×” ××§×¦×•×¢×™</h3>
        <div id="fullSheet" class="synced-sheet">â€”</div>
        
        <h3 style="margin-top:16px">ğŸ™ï¸ ×ª××œ×•×œ ××œ×</h3>
        <div id="fullTranscript" style="max-height:300px;overflow:auto;background:#0b1221;padding:12px;border-radius:8px;white-space:pre-wrap;font-family:Arial">â€”</div>
        
        <div class="row" style="margin-top:12px">
          <button id="exportBtn">ğŸ’¾ ×™×™×¦× ×œ-ChordPro</button>
          <button id="copyBtn">ğŸ“‹ ×”×¢×ª×§ ×“×£</button>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <label>ğŸ¯ ××¦×‘ ×–×™×”×•×™:
          <select id="extMode">
            <option value="basic">×‘×¡×™×¡×™ (triads + 7ths)</option>
            <option value="jazz" selected>ğŸ· ×’'××– (+ 9/11/13/sus/6th)</option>
          </select>
        </label>
        <label>×§×•×•× ×˜×”:
          <select id="quant">
            <option value="4" selected>1/4</option>
            <option value="8">1/8</option>
          </select>
        </label>
        <label>ğŸ¸ ×§××¤×•:
          <input id="capo" type="number" value="0" min="0" max="11" style="width:80px" />
        </label>
        <label>ğŸšï¸ ××•×“×™×•:
          <select id="audioMode">
            <option value="mono" selected>××•× ×• (××”×™×¨)</option>
            <option value="stereo">2 ×¢×¨×•×¦×™× (××“×•×™×§)</option>
          </select>
        </label>
        <button id="analyzeBtn">× ×ª×—</button>
        <button id="playBtn" disabled>â–¶ ×”×¤×¢×œ</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge">BPM: <b id="bpm">â€”</b></span>
        <span class="badge">××©×š: <b id="dur">â€”</b></span>
        <span class="badge" style="cursor:pointer" title="×œ×—×¥ ×œ×”×—×œ×¤×ª ××–'×•×¨/××™× ×•×¨">
          ×¡×•×œ×: <b id="keyBadge" onclick="toggleMajorMinor()">â€”</b>
        </span>
        <button onclick="refreshKeyDisplay()" style="padding:4px 10px;font-size:12px" title="×¨×¢× ×Ÿ ×¡×•×œ×">ğŸ”„</button>
        <button onclick="transposeDown()" style="padding:4px 10px;font-size:12px" title="×”×•×¨×“ ×—×¦×™ ×˜×•×Ÿ">â™­</button>
        <button onclick="transposeUp()" style="padding:4px 10px;font-size:12px" title="×”×¢×œ×” ×—×¦×™ ×˜×•×Ÿ">â™¯</button>
        <span class="badge">××¦×‘: <b id="modeBadge">â€”</b></span>
      </div>

      <div id="status" class="pill ok" style="display:none"></div>
      <div id="error" class="pill err" style="display:none"></div>

      <div class="sliderRow">
        <span class="tag">Ã—<span id="bassSensTxt">1.0</span></span>
        <input id="bassSens" type="range" min="0.5" max="2.0" step="0.1" value="1.0" />
        <span style="color:#94a3b8;font-size:12px">×¨×’×™×©×•×ª ×‘×¡ (inversions/slash chords)</span>
      </div>
      <div class="sliderRow">
        <span class="tag">Ã—<span id="extSensTxt">1.0</span></span>
        <input id="extSens" type="range" min="0.5" max="2.0" step="0.1" value="1.0" />
        <span style="color:#94a3b8;font-size:12px">×¨×’×™×©×•×ª ×”×¨×—×‘×•×ª (7/maj7/9/11/13/sus)</span>
      </div>

      <div class="row">
        <span id="gateChip" class="chip warn" style="display:none"><span class="dot"></span>××—×›×” ×œ×¤×¨×™×˜×”...</span>
      </div>
    </section>

    <section class="panel">
      <h2>× ×™×ª×•×— ×”×¨××•× ×™ ××ª×§×“×</h2>
      <div class="analysis-grid">
        <div class="analysis-card">
          <h3>××§×•×¨×“×™× ××‘× ×™×™×</h3>
          <div class="value" id="structuralCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>×§×™×©×•×˜×™×</h3>
          <div class="value" id="ornamentCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>×“×•××™× × ×˜ ××©× ×™</h3>
          <div class="value" id="secDomCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>×”×©××œ×•×ª ××•×“××œ×™×•×ª</h3>
          <div class="value" id="modalBorrowCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>ğŸ”€ ××•×“×•×œ×¦×™×•×ª</h3>
          <div class="value" id="modulationCount">â€”</div>
        </div>
      </div>
      
      <h3 style="margin-top:16px">ğŸ» ××§×•×¨×“×™× ×˜×‘×¢×™×™× ×‘×¡×•×œ× (Circle of Fifths)</h3>
      <div id="circleOfFifths" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">â€”</div>
    </section>

    <section class="panel">
      <h2>×ª×¦×•×’×” ×—×™×”</h2>
      <audio id="player" controls preload="auto" crossorigin="anonymous" style="width:100%"></audio>
      <div class="live">
        <div style="flex:1">
          <div class="title">×”××§×•×¨×“ ×›×¨×’×¢</div>
          <div class="ch" id="liveChord">â€”</div>
          <div class="func" id="liveFunction">â€”</div>
          <div class="lyric" id="liveLyric">â€”</div>
        </div>
        <div style="text-align:left">
          <span id="ornamentChip" class="chip ornament" style="display:none">×§×™×©×•×˜</span>
          <span id="structuralChip" class="chip structural" style="display:none">××‘× ×™</span>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>ğŸ“ ×“×£ × ×’×™× ×” â€“ ×–××Ÿ ×××ª</h2>
      <div id="liveSheet" class="synced-sheet">â€”</div>
      <div class="row" style="margin-top:8px">
        <button id="resetSheet">××¤×¡ ×“×£</button>
      </div>
    </section>
  </div>

<script src="ChordEngineEnhanced_v14.36_UltimateMinorDetection.js?v=2"></script>
<script src="sync-engine-v6.14.js" onerror="console.warn('sync-engine not loaded')"></script>
<script src="hebrew-spell-checker.js"></script>

<script>
let engine;
window.addEventListener('DOMContentLoaded', () => {
  if (typeof ChordEngineEnhanced === 'undefined') {
    alert('âŒ ChordEngineEnhanced_v14.36_UltimateMinorDetection.js ×œ× × ×˜×¢×Ÿ!');
    throw new Error('Engine not loaded');
  }
  try {
    engine = new ChordEngineEnhanced();
    console.log('âœ… Engine v14.36 Ultimate Minor Detection initialized');
  } catch(e) {
    alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª Engine: ' + e.message);
    throw e;
  }
});

const SERVER = window.location.origin;
let selectedYouTubeVideo = null;
let currentTab = 'file';
let WHISPER_SEGMENTS = [];
let WHISPER_WORDS = [];
let WHISPER_TEXT = '';
let WHISPER_RUNNING = false;
let DETECTED_LANGUAGE = 'en';
let LIVE_STREAM = [];
let LIVE_POINTER = 0;

const fileEl=document.getElementById('file');
const analyzeBtn=document.getElementById('analyzeBtn');
const playBtn=document.getElementById('playBtn');
const statusEl=document.getElementById('status');
const errorEl=document.getElementById('error');
const whisperStatusEl=document.getElementById('whisperStatus');
const fullTranscriptEl=document.getElementById('fullTranscript');
const fullSheetEl=document.getElementById('fullSheet');
const gateChip=document.getElementById('gateChip');
const player=document.getElementById('player');
const bpmEl=document.getElementById('bpm');
const durEl=document.getElementById('dur');
const capoEl=document.getElementById('capo');
const keyBadge=document.getElementById('keyBadge');
const modeBadge=document.getElementById('modeBadge');
const liveChordEl=document.getElementById('liveChord');
const liveFunctionEl=document.getElementById('liveFunction');
const liveLyricEl=document.getElementById('liveLyric');
const liveSheetEl=document.getElementById('liveSheet');
const resetSheetBtn=document.getElementById('resetSheet');
const exportBtn=document.getElementById('exportBtn');
const copyBtn=document.getElementById('copyBtn');
const structuralCountEl=document.getElementById('structuralCount');
const ornamentCountEl=document.getElementById('ornamentCount');
const secDomCountEl=document.getElementById('secDomCount');
const modalBorrowCountEl=document.getElementById('modalBorrowCount');
const modulationCountEl=document.getElementById('modulationCount');
const ornamentChip=document.getElementById('ornamentChip');
const structuralChip=document.getElementById('structuralChip');
const ytSearchEl=document.getElementById('ytSearch');
const ytSearchBtn=document.getElementById('ytSearchBtn');
const ytResultsEl=document.getElementById('ytResults');
const bassSensEl = document.getElementById('bassSens');
const extSensEl = document.getElementById('extSens');
const bassSensTxt = document.getElementById('bassSensTxt');
const extSensTxt = document.getElementById('extSensTxt');
const ytStatusEl=document.getElementById('ytStatus');
const ytUrlEl=document.getElementById('ytUrl');
const ytUrlBtn=document.getElementById('ytUrlBtn');

bassSensEl.oninput = () => { bassSensTxt.textContent = Number(bassSensEl.value).toFixed(1); };
extSensEl.oninput = () => { extSensTxt.textContent = Number(extSensEl.value).toFixed(1); };

function refreshSheetTabView(){
  if(typeof SyncEngine !== 'undefined') {
    SyncEngine.refreshSheetTabView(window.__STATE, WHISPER_WORDS, WHISPER_TEXT, DETECTED_LANGUAGE, capoEl.value, sanitizeLabel, applyCapoToLabel, fullSheetEl);
  }
}

function initTabs() {
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.getAttribute('data-tab');
      currentTab = tabName;
      tabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      tabContents.forEach(content => content.classList.remove('active'));
      const targetContent = document.getElementById(tabName + 'Tab');
      if(targetContent) targetContent.classList.add('active');
      if(tabName === 'sheet') refreshSheetTabView();
    });
  });
}
initTabs();

async function correctHebrewWords(words, fullText) {
  if(typeof HebrewSpellChecker === 'undefined') return words;
  const corrected = HebrewSpellChecker.correctWords(words);
  const corrections = corrected.filter(w => w.original).length;
  if (corrections > 0) console.log(`âœ… Fixed ${corrections} Hebrew words`);
  return corrected;
}

async function runWhisperInBackground(videoId) {
  if(WHISPER_RUNNING) return;
  WHISPER_RUNNING = true;
  whisperStatusEl.style.display = 'inline-flex';
  whisperStatusEl.textContent = '×˜×•×¢×Ÿ Groq Whisper...';
  
  try {
    const url = `${SERVER}/api/groq-transcribe`;
    const r = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ videoId: videoId })
    });
    
    if(!r.ok) throw new Error(`Failed: ${r.status}`);
    
    const data = await r.json();
    
    if(data.success) {
      WHISPER_SEGMENTS = data.segments || [];
      WHISPER_WORDS = data.words || [];
      WHISPER_TEXT = data.text || '';
      DETECTED_LANGUAGE = data.language || 'en';
      
      if (DETECTED_LANGUAGE === 'he' && WHISPER_WORDS.length > 0) {
        WHISPER_WORDS = await correctHebrewWords(WHISPER_WORDS, WHISPER_TEXT);
      }
      
      whisperStatusEl.textContent = 'âœ… Groq Whisper';
      whisperStatusEl.classList.remove('warn');
      whisperStatusEl.classList.add('ok');
      if(window.__STATE && window.__STATE.timeline) {
        syncChordsWithLyrics();
        displayWhisperResult();
        refreshSheetTabView();
        const isRTL = DETECTED_LANGUAGE === 'he';
        buildFullLyricsSheet(isRTL);
      }
      setTimeout(() => whisperStatusEl.style.display = 'none', 2500);
    } else throw new Error(data.error || 'Failed');
  } catch(e) {
    whisperStatusEl.textContent = 'âŒ ×©×’×™××”';
    whisperStatusEl.classList.add('err');
    setTimeout(() => whisperStatusEl.style.display = 'none', 4000);
  } finally {
    WHISPER_RUNNING = false;
  }
}

function syncChordsWithLyrics(){
  if(typeof SyncEngine !== 'undefined') {
    LIVE_STREAM = SyncEngine.syncChordsWithLyrics(window.__STATE, WHISPER_WORDS, capoEl.value, sanitizeLabel, applyCapoToLabel);
    LIVE_POINTER = 0;
  }
}

function displayWhisperResult() {
  if(!WHISPER_TEXT || WHISPER_TEXT.trim() === '') {
    fullTranscriptEl.textContent = 'ğŸ’¬ ×ª××œ×•×œ ×œ× ×–××™×Ÿ';
    return;
  }
  const lang = DETECTED_LANGUAGE === 'he' ? '×¢×‘×¨×™×ª' : (DETECTED_LANGUAGE === 'en' ? 'English' : DETECTED_LANGUAGE);
  fullTranscriptEl.textContent = `ğŸ™ï¸ [Groq Whisper - ${lang}]\n\n${WHISPER_TEXT}`;
}
