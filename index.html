<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ChordFinderPro v14.36 ğŸµ DEBUG</title>
  
  <meta name="description" content="ğŸµ ×–×™×”×•×™ ××§×•×¨×“×™× ××ª×§×“× ×¢× AI" />
  <meta name="theme-color" content="#38bdf8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <style>
    :root{--bg:#0b1022;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--card:#0a1324;--border:#1b2333;--brand:#22c55e;--accent:#38bdf8;--alert:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);direction:rtl}
    .wrap{max-width:1200px;margin:auto;padding:18px;padding-bottom:80px}
    h1{margin:6px 0 10px;font-size:24px}
    .muted{color:var(--muted);font-size:14px}
    .panel{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"], select, button, input[type="number"], input[type="text"]{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;appearance:none;font-weight:700;cursor:pointer}
    input[type="text"]{width:100%;max-width:500px;font-weight:400}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1221;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px}
    .badge.pro{border-color:#664d23;background:#2e1f0d;color:#ffd7a3}
    .badge.bass{border-color:#f59e0b;background:#3a2a0c;color:#fff0d9}
    .badge.refiner{border-color:#a855f7;background:#2e1f3a;color:#e9d5ff}
    .live{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:18px;margin-top:10px}
    .live .title{color:#a9b4c8;font-size:13px}
    .live .ch{font-weight:800;font-size:42px}
    .live .func{font-size:14px;color:#38bdf8;margin-top:4px}
    .live .lyric{font-size:18px;color:#cbd5e1;margin-top:12px;font-style:italic;direction:rtl;line-height:1.6;background:#0a1324;padding:10px;border-radius:8px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3d55;margin:2px 4px;background:#0b1221}
    .ok{border-color:#1f5f3f;color:#d7ffe6;background:#0d2e1f}
    .err{border-color:#5f2323;color:#ffe0e0;background:#3f1d1d}
    .warn{border-color:#8a6a1f;color:#fff0d9;background:#3a2a0c}
    .spin{width:12px;height:12px;border-radius:50%;border:2px solid var(--accent);border-top-color:transparent;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .tabs{display:flex;gap:4px;margin-bottom:12px}
    .tab{padding:8px 16px;border-radius:8px;background:#0b1221;border:1px solid #1f2a40;cursor:pointer;transition:all 0.2s}
    .tab.active{background:#0d2e1f;border-color:#22c55e;color:#d7ffe6}
    .tab:hover{border-color:#38bdf8}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .synced-sheet{background:#0a1324;color:#e5e7eb;padding:24px;border-radius:12px;font-family:'Courier New',Courier,monospace;line-height:1.8;overflow-x:auto;max-width:100%;white-space:pre;border:1px solid #1f2a40}
    .analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-top:12px}
    .analysis-card{background:#0b1221;border:1px solid #1f2a40;border-radius:12px;padding:12px}
    .analysis-card h3{margin:0 0 8px 0;font-size:14px;color:#38bdf8}
    .analysis-card .value{font-size:20px;font-weight:700;color:#22c55e}
    
    /* Debug Table Styles */
    .debug-table{width:100%;border-collapse:collapse;margin-top:15px;font-size:13px;background:#0a1324;border-radius:8px;overflow:hidden}
    .debug-table th{background:#1a2332;color:#38bdf8;padding:12px 8px;text-align:center;font-weight:700;border-bottom:2px solid #2a3d55;font-size:12px}
    .debug-table td{padding:10px 8px;border-bottom:1px solid #1f2a40;text-align:center;vertical-align:middle}
    .debug-table tr:hover{background:#12203a}
    .debug-table tr.refiner-changed{background:#1a2a1a}
    .debug-table tr.bass-changed{background:#1a1a2a}
    .chord-cell{font-weight:bold;font-size:14px;color:#f0f0f0}
    .refiner-cell.major{color:#4ade80}
    .refiner-cell.minor{color:#f472b6}
    .refiner-cell.unclear{color:#94a3b8}
    .bass-cell.detected{color:#38bdf8;font-weight:600}
    .bass-cell.no-bass{color:#64748b;font-style:italic}
    .debug-stats{display:flex;gap:20px;flex-wrap:wrap;margin:10px 0;padding:10px;background:#0c162b;border-radius:8px}
    .debug-stats .stat{color:#94a3b8;font-size:13px}
    .debug-stats .stat strong{color:#e5e7eb}
    .filter-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .filter-btn{padding:6px 12px;border-radius:8px;background:#0b1221;border:1px solid #1f2a40;color:#cbd5e1;cursor:pointer;font-size:12px}
    .filter-btn.active{background:#164e3a;border-color:#22c55e;color:#d7ffe6}
  </style>
</head>
<body>

  <div class="wrap">
    <h1>Chord Finder Pro v14.36
      <span class="badge pro">AI Enhanced</span>
      <span class="badge bass">ğŸ¸ Bass v4.3</span>
      <span class="badge refiner">ğŸµ Refiner v4.3</span>
    </h1>
    <div class="muted">
      ×–×™×”×•×™ ××§×•×¨×“×™× + × ×™×ª×•×— ×‘×¡ + ×–×™×”×•×™ ××–×³×•×¨/××™× ×•×¨
    </div>

    <section class="panel">
      <div class="tabs">
        <div class="tab active" data-tab="file">ğŸ“ ×§×•×‘×¥</div>
        <div class="tab" data-tab="debug">ğŸ”¬ ×“×™×‘××’</div>
      </div>

      <div id="fileTab" class="tab-content active">
        <div class="row">
          <input id="file" type="file" accept="audio/*,video/*" />
        </div>
      </div>

      <div id="debugTab" class="tab-content">
        <h3>ğŸ”¬ × ×™×ª×•×— ××¤×•×¨×˜ ××§×•×¨×“-××§×•×¨×“</h3>
        
        <div class="filter-row">
          <span style="color:#94a3b8">âš™ï¸ ×¡×™× ×•×Ÿ:</span>
          <button class="filter-btn active" data-filter="all">×”×›×œ</button>
          <button class="filter-btn" data-filter="refiner">×¨×§ Refiner ×©×™× ×”</button>
          <button class="filter-btn" data-filter="bass">×¨×§ Bass ×©×™× ×”</button>
          <button class="filter-btn" data-filter="changes">×›×œ ×”×©×™× ×•×™×™×</button>
        </div>
        
        <div class="debug-stats" id="debugStats">
          <span class="stat">×¡×”×´×›: <strong id="statTotal">â€”</strong></span>
          <span class="stat">×‘×¡×™×¡: <strong id="statBass">â€”</strong></span>
          <span class="stat">ğŸµ Refiner ×©×™× ×”: <strong id="statRefiner">â€”</strong></span>
          <span class="stat">ğŸ¸ Bass ×©×™× ×”: <strong id="statBassChanged">â€”</strong></span>
        </div>
        
        <div id="debugTableContainer" style="max-height:500px;overflow-y:auto">
          <div style="color:#64748b;padding:40px;text-align:center">×× ×ª×—...</div>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <label>ğŸ¸ ×§××¤×•:
          <input id="capo" type="number" value="0" min="0" max="11" style="width:80px" />
        </label>
        <button id="analyzeBtn">ğŸ” × ×ª×— + ×“×™×‘××’ ××œ×</button>
        <button id="playBtn" disabled>â–¶ ×”×¤×¢×œ</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge">BPM: <b id="bpm">â€”</b></span>
        <span class="badge">××©×š: <b id="dur">â€”</b></span>
        <span class="badge">×¡×•×œ×: <b id="keyBadge">â€”</b></span>
        <span class="badge">××¦×‘: <b id="modeBadge">â€”</b></span>
      </div>

      <div id="status" class="pill ok" style="display:none"></div>
      <div id="error" class="pill err" style="display:none"></div>
    </section>

    <section class="panel">
      <h2>ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</h2>
      <div class="analysis-grid">
        <div class="analysis-card">
          <h3>×¡×”"×› ××§×•×¨×“×™×</h3>
          <div class="value" id="totalChordsCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>ğŸ¸ Bass ×©×™× ×”</h3>
          <div class="value" id="bassChangesCount">â€”</div>
        </div>
        <div class="analysis-card">
          <h3>ğŸµ Refiner ×©×™× ×”</h3>
          <div class="value" id="refinerChangesCount">â€”</div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>×ª×¦×•×’×” ×—×™×”</h2>
      <audio id="player" controls preload="auto" style="width:100%"></audio>
      <div class="live">
        <div class="title">×”××§×•×¨×“ ×›×¨×’×¢</div>
        <div class="ch" id="liveChord">â€”</div>
        <div class="func" id="liveFunction">â€”</div>
      </div>
    </section>
  </div>

<!-- Load engines -->
<script src="BassEngine_v4.3.js"></script>
<script src="MajorMinorRefiner_v4.3.js"></script>
<script src="ChordEngine_v14.36_INTEGRATED.js"></script>

<script>
let engine;
let debugData = [];

window.addEventListener('DOMContentLoaded', () => {
  if (typeof ChordEngineEnhanced === 'undefined') {
    alert('âŒ ChordEngine ×œ× × ×˜×¢×Ÿ!');
    return;
  }
  engine = new ChordEngineEnhanced();
  console.log('âœ… Engine loaded');
  console.log('   BassEngine:', typeof BassEngine !== 'undefined' ? 'âœ…' : 'âŒ');
  console.log('   MajorMinorRefiner:', typeof MajorMinorRefiner !== 'undefined' ? 'âœ…' : 'âŒ');
});

// Elements
const fileEl = document.getElementById('file');
const analyzeBtn = document.getElementById('analyzeBtn');
const playBtn = document.getElementById('playBtn');
const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const player = document.getElementById('player');
const bpmEl = document.getElementById('bpm');
const durEl = document.getElementById('dur');
const capoEl = document.getElementById('capo');
const keyBadge = document.getElementById('keyBadge');
const modeBadge = document.getElementById('modeBadge');
const liveChordEl = document.getElementById('liveChord');
const liveFunctionEl = document.getElementById('liveFunction');
const totalChordsCountEl = document.getElementById('totalChordsCount');
const bassChangesCountEl = document.getElementById('bassChangesCount');
const refinerChangesCountEl = document.getElementById('refinerChangesCount');
const debugTableContainer = document.getElementById('debugTableContainer');

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    this.classList.add('active');
    document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
  });
});

// Filters
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    renderDebugTable(this.dataset.filter);
  });
});

function showStatus(msg, type) {
  statusEl.textContent = msg;
  statusEl.className = 'pill ' + type;
  statusEl.style.display = 'inline-flex';
}

function showError(msg) {
  errorEl.textContent = msg;
  errorEl.style.display = 'inline-flex';
}

function hideAlerts() {
  statusEl.style.display = 'none';
  errorEl.style.display = 'none';
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  const ms = Math.floor((seconds % 1) * 10);
  return `${m}:${s.toString().padStart(2, '0')}.${ms}`;
}

function renderDebugTable(filter = 'all') {
  if (!debugData.length) {
    debugTableContainer.innerHTML = '<div style="color:#64748b;padding:40px;text-align:center">××™×Ÿ × ×ª×•× ×™×</div>';
    return;
  }
  
  let filtered = debugData;
  if (filter === 'refiner') filtered = debugData.filter(r => r.refinerChanged);
  else if (filter === 'bass') filtered = debugData.filter(r => r.bassChanged);
  else if (filter === 'changes') filtered = debugData.filter(r => r.refinerChanged || r.bassChanged);
  
  let html = `<table class="debug-table">
    <thead><tr>
      <th>#</th>
      <th>â± ×–××Ÿ</th>
      <th>ğŸ¹ ×× ×•×¢ ×‘×¡×™×¡×™</th>
      <th>ğŸµ Refiner<br>××–×³×•×¨/××™× ×•×¨</th>
      <th>ğŸ¸ Bass<br>×–×™×”×•×™</th>
    </tr></thead><tbody>`;
  
  for (const row of filtered) {
    let refinerDisplay = 'â€”';
    let refinerClass = '';
    if (row.refinerDetected === 'major') {
      refinerDisplay = `â–² ××–×³×•×¨ (${Math.round(row.refinerConfidence * 100)}%)`;
      refinerClass = 'major';
    } else if (row.refinerDetected === 'minor') {
      refinerDisplay = `â–¼ ××™× ×•×¨ (${Math.round(row.refinerConfidence * 100)}%)`;
      refinerClass = 'minor';
    } else if (row.refinerDetected) {
      refinerDisplay = row.refinerDetected;
      refinerClass = 'unclear';
    }
    
    let bassDisplay = 'â€”';
    let bassClass = 'no-bass';
    if (row.bassDetected && row.bassDetected !== 'NO_BASS') {
      bassDisplay = `${row.bassDetected} (${Math.round(row.bassConfidence * 100)}%)`;
      bassClass = 'detected';
    }
    
    let rowClass = '';
    if (row.refinerChanged) rowClass += ' refiner-changed';
    if (row.bassChanged) rowClass += ' bass-changed';
    
    html += `<tr class="${rowClass}">
      <td>${row.index}</td>
      <td>${formatTime(row.time)}</td>
      <td class="chord-cell">${row.finalLabel}</td>
      <td class="refiner-cell ${refinerClass}">${refinerDisplay}</td>
      <td class="bass-cell ${bassClass}">${bassDisplay}</td>
    </tr>`;
  }
  
  html += '</tbody></table>';
  debugTableContainer.innerHTML = html;
}

analyzeBtn.onclick = async () => {
  hideAlerts();
  debugData = [];
  liveChordEl.textContent = 'â€”';
  liveFunctionEl.textContent = 'â€”';
  playBtn.disabled = true;
  
  const f = fileEl.files?.[0];
  if (!f) { showError('×‘×—×¨ ×§×•×‘×¥'); return; }
  
  try {
    showStatus('×˜×•×¢×Ÿ ××•×“×™×•...', 'warn');
    
    const AC = window.AudioContext || window.webkitAudioContext;
    const ctx = new AC();
    const arr = await f.arrayBuffer();
    const audioBuffer = await ctx.decodeAudioData(arr);
    
    player.src = URL.createObjectURL(f);
    bpmEl.textContent = '120';
    durEl.textContent = audioBuffer.duration.toFixed(1) + 's';
    
    showStatus('×× ×ª×— ××§×•×¨×“×™×...', 'warn');
    
    const result = await engine.detect(audioBuffer, {
      useBassEngine: true,
      useMajorMinorRefiner: true,
      debug: true
    });
    
    // Update UI
    const keyName = engine.NOTES_SHARP[engine.toPc(result.key.root)] + (result.key.minor ? 'm' : '');
    keyBadge.textContent = keyName;
    modeBadge.textContent = result.key.minor ? 'Minor' : 'Major';
    
    // Build debug data
    const timeline = result.chords || [];
    const refinerResults = result._debug?.refinerResults || [];
    const bassResults = result._debug?.bassResults || [];
    
    debugData = [];
    for (let i = 0; i < timeline.length; i++) {
      const chord = timeline[i];
      const refiner = refinerResults[i] || {};
      const bass = bassResults[i] || {};
      
      debugData.push({
        index: i + 1,
        time: chord.t || 0,
        engineLabel: chord.originalLabel || chord.label,
        finalLabel: chord.label,
        refinerDetected: refiner.detectedQuality || 'â€”',
        refinerConfidence: refiner.qualityConfidence || 0,
        refinerChanged: refiner.shouldOverride || false,
        bassDetected: bass.bassDetected || chord.bassDetected || 'â€”',
        bassConfidence: bass.bassConfidence || chord.bassConfidence || 0,
        bassChanged: chord.changedByBass || false
      });
    }
    
    // Stats
    const total = debugData.length;
    const bassDetected = debugData.filter(r => r.bassDetected && r.bassDetected !== 'NO_BASS' && r.bassDetected !== 'â€”').length;
    const refinerChanges = debugData.filter(r => r.refinerChanged).length;
    const bassChanges = debugData.filter(r => r.bassChanged).length;
    
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statBass').textContent = bassDetected;
    document.getElementById('statRefiner').textContent = refinerChanges;
    document.getElementById('statBassChanged').textContent = bassChanges;
    
    totalChordsCountEl.textContent = total;
    bassChangesCountEl.textContent = bassChanges;
    refinerChangesCountEl.textContent = refinerChanges;
    
    renderDebugTable('all');
    
    // Store for playback
    window.__STATE = { timeline, key: result.key };
    
    showStatus(`âœ… ${total} ××§×•×¨×“×™× | Bass: ${bassChanges} | Refiner: ${refinerChanges}`, 'ok');
    playBtn.disabled = false;
    
    // Auto switch to debug tab
    document.querySelector('[data-tab="debug"]').click();
    
  } catch (e) {
    console.error(e);
    showError('×©×’×™××”: ' + e.message);
  }
};

playBtn.onclick = () => player.play();

player.ontimeupdate = () => {
  const st = window.__STATE;
  if (!st) return;
  
  const t = player.currentTime;
  let idx = st.timeline.findIndex(x => x.t > t);
  if (idx === -1) idx = st.timeline.length;
  const ev = st.timeline[idx - 1] || st.timeline[0];
  
  if (ev?.label) {
    liveChordEl.textContent = ev.label;
    
    // Highlight in table
    document.querySelectorAll('.debug-table tr').forEach(row => {
      row.style.background = '';
    });
    const rows = document.querySelectorAll('.debug-table tbody tr');
    if (rows[idx - 1]) {
      rows[idx - 1].style.background = '#1e3a5f';
      rows[idx - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
};
</script>

</body>
</html>
