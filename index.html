<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChordFinder Pro ULTIMATE - ×–×™×”×•×™ ××§×•×¨×“×™× ××ª×§×“×</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 16px;
      border: 1px solid rgba(56, 189, 248, 0.2);
    }

    h1 {
      font-size: 2.5em;
      background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .version-badge {
      display: inline-block;
      background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 1.1em;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(30, 41, 59, 0.7);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(56, 189, 248, 0.2);
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(56, 189, 248, 0.3);
    }

    .panel-title {
      font-size: 1.4em;
      font-weight: bold;
      color: #38bdf8;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #cbd5e1;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 1em;
      transition: all 0.3s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
    }

    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-top: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(56, 189, 248, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px;
      background: rgba(15, 23, 42, 0.7);
      border: 2px dashed rgba(56, 189, 248, 0.5);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      color: #94a3b8;
    }

    .file-input-label:hover {
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.1);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 640px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    .status.info {
      background: rgba(56, 189, 248, 0.2);
      border: 1px solid #38bdf8;
      color: #38bdf8;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      color: #22c55e;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #ef4444;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #38bdf8 0%, #818cf8 100%);
      width: 0%;
      transition: width 0.3s;
    }

    .sheet-tab {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 8px;
      padding: 20px;
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      line-height: 1.8;
    }

    .sheet-tab.rtl {
      direction: rtl;
      text-align: right;
    }

    .sheet-tab.ltr {
      direction: ltr;
      text-align: left;
    }

    .chord {
      color: #38bdf8;
      font-weight: bold;
      font-size: 1.1em;
    }

    .lyric {
      color: #e2e8f0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: rgba(15, 23, 42, 0.5);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid rgba(56, 189, 248, 0.2);
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #38bdf8;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #94a3b8;
      font-size: 0.9em;
    }

    .export-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .secondary-btn {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    }

    .audio-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .audio-controls button {
      flex: 1;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(56, 189, 248, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(56, 189, 248, 0.7);
    }

    .feature-badge {
      display: inline-block;
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      margin-left: 8px;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .info-box {
      background: rgba(56, 189, 248, 0.1);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-size: 0.9em;
      color: #cbd5e1;
    }

    .info-box strong {
      color: #38bdf8;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¸ ChordFinder Pro ULTIMATE</h1>
      <div class="version-badge">v2.2.0 ULTIMATE Edition</div>
      <p class="subtitle">×–×™×”×•×™ ××§×•×¨×“×™× ××ª×§×“× ×¢× AI | Modulation Detection | Harmonic Analysis</p>
    </header>

    <div class="main-content">
      <!-- Left Panel: Input -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">ğŸ“¥ ×§×œ×˜</span>
        </div>

        <div class="input-group">
          <label>ğŸµ ×”×¢×œ××ª ×§×•×‘×¥ ××•×“×™×•</label>
          <div class="file-input-wrapper">
            <input type="file" id="audioFile" accept="audio/*">
            <label for="audioFile" class="file-input-label">
              <span>ğŸ“</span>
              <span>×‘×—×¨ ×§×•×‘×¥ ××•×“×™×• (MP3, WAV, etc.)</span>
            </label>
          </div>
        </div>

        <div class="input-group">
          <label>××•: ğŸ”— YouTube URL</label>
          <input type="text" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=...">
          <button id="fetchYoutubeBtn" onclick="fetchFromYouTube()">×©×œ×•×£ ×-YouTube</button>
        </div>

        <div class="settings-grid">
          <div class="input-group">
            <label>ğŸ¹ Capo</label>
            <input type="number" id="capoInput" value="0" min="0" max="12">
          </div>

          <div class="input-group">
            <label>ğŸ¥ BPM (××•×¤×¦×™×•× ×œ×™)</label>
            <input type="number" id="bpmInput" placeholder="××•×˜×•××˜×™" min="40" max="240">
          </div>

          <div class="input-group">
            <label>ğŸ¼ ××¦×‘ ×–×™×”×•×™</label>
            <select id="modeSelect">
              <option value="accurate">Accurate (××™×˜×™ ×™×•×ª×¨, ××“×•×™×§ ×™×•×ª×¨)</option>
              <option value="balanced" selected>Balanced (××•××œ×¥)</option>
              <option value="fast">Fast (××”×™×¨)</option>
            </select>
          </div>

          <div class="input-group">
            <label>ğŸµ Harmony Mode</label>
            <select id="harmonyModeSelect">
              <option value="pro" selected>Pro (××•××œ×¥)</option>
              <option value="basic">Basic</option>
            </select>
          </div>
        </div>

        <button id="analyzeBtn" onclick="analyzeAudio()" disabled>ğŸ¸ × ×ª×— ××§×•×¨×“×™×</button>

        <div id="statusBox" class="status"></div>
        <div id="progressBar" class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>

        <div class="info-box">
          <strong>âœ¨ ×ª×›×•× ×•×ª ULTIMATE:</strong><br>
          â€¢ Enhanced 7ths/9ths/11ths/13ths (+20%)<br>
          â€¢ Modulation Detection (Câ†’F, Câ†’G)<br>
          â€¢ Bass Harmonic Series Analysis<br>
          â€¢ Spectral Centroid for Major/Minor<br>
          â€¢ Rhythmic Pattern Analysis<br>
          â€¢ Advanced Inversion Detection<br>
          â€¢ Enhanced Key Detection (fixes Am/C)
        </div>
      </div>

      <!-- Right Panel: Output -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">ğŸ“Š ×ª×•×¦××•×ª</span>
          <span class="feature-badge">LIVE</span>
        </div>

        <div class="input-group">
          <label>ğŸ¹ ××¤×ª×— ××–×•×”×”: <span id="detectedKey" style="color: #38bdf8; font-weight: bold;">-</span></label>
          <label>ğŸ¥ BPM: <span id="detectedBpm" style="color: #38bdf8; font-weight: bold;">-</span></label>
          <label>ğŸ¼ Mode: <span id="detectedMode" style="color: #38bdf8; font-weight: bold;">-</span></label>
        </div>

        <div class="sheet-tab" id="sheetTab">
          <div style="color:#64748b; text-align:center; padding: 40px;">
            â³ ×××ª×™×Ÿ ×œ× ×™×ª×•×—...
          </div>
        </div>

        <div class="audio-controls">
          <button id="playBtn" onclick="togglePlayback()" disabled>â–¶ï¸ × ×’×Ÿ</button>
          <button id="pauseBtn" onclick="pausePlayback()" disabled>â¸ï¸ ×”×©×”×”</button>
          <button id="stopBtn" onclick="stopPlayback()" disabled>â¹ï¸ ×¢×¦×•×¨</button>
        </div>

        <div class="export-buttons">
          <button onclick="exportChordPro()">ğŸ’¾ ×™×™×¦× ChordPro</button>
          <button class="secondary-btn" onclick="exportJSON()">ğŸ“„ ×™×™×¦× JSON</button>
        </div>

        <!-- Stats -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
          <div class="stat-card">
            <div class="stat-value" id="statTotalChords">0</div>
            <div class="stat-label">××§×•×¨×“×™×</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statExtensions">0</div>
            <div class="stat-label">Extensions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statInversions">0</div>
            <div class="stat-label">Inversions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statModulations">0</div>
            <div class="stat-label">Modulations</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statConfidence">0%</div>
            <div class="stat-label">Confidence</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statProcessingTime">0s</div>
            <div class="stat-label">×–××Ÿ ×¢×™×‘×•×“</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load engines -->
  <script src="chord-engine.js"></script>
<script src="enhanced-key-detection.js"></script>
  <script src="enhanced-key-detection.js"></script>
  <script src="chord-engine-pro-ultimate.js"></script>
  <script src="sync-engine.js"></script>

  <script>
    // Global state
    let state = {
      audioBuffer: null,
      audioContext: null,
      source: null,
      timeline: [],
      words: [],
      key: null,
      bpm: 120,
      isPlaying: false,
      currentTime: 0,
      gateTime: 0
    };

    // Initialize
    document.getElementById('audioFile').addEventListener('change', handleFileUpload);

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      showStatus('×˜×•×¢×Ÿ ×§×•×‘×¥...', 'info');
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          if (!state.audioContext) {
            state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          state.audioBuffer = await state.audioContext.decodeAudioData(e.target.result);
          
          showStatus('âœ… ×§×•×‘×¥ × ×˜×¢×Ÿ! ×œ×—×¥ "× ×ª×— ××§×•×¨×“×™×"', 'success');
          document.getElementById('analyzeBtn').disabled = false;
        } catch (error) {
          showStatus('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•×‘×¥: ' + error.message, 'error');
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    async function fetchFromYouTube() {
      const url = document.getElementById('youtubeUrl').value.trim();
      if (!url) {
        showStatus('âŒ ×”×–×Ÿ URL ×©×œ YouTube', 'error');
        return;
      }

      showStatus('ğŸ” ××•×¨×™×“ ×-YouTube...', 'info');
      // TODO: Implement YouTube download via backend API
      showStatus('âŒ ×ª×›×•× ×” ×–×• ×“×•×¨×©×ª backend server', 'error');
    }

    async function analyzeAudio() {
      if (!state.audioBuffer) {
        showStatus('âŒ ×˜×¢×Ÿ ×§×•×‘×¥ ×§×•×“×', 'error');
        return;
      }

      showStatus('ğŸ¸ ×× ×ª×—...', 'info');
      showProgress(0);

      const analyzeBtn = document.getElementById('analyzeBtn');
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = 'â³ ×× ×ª×—...';

      try {
        // Get settings
        const capo = parseInt(document.getElementById('capoInput').value) || 0;
        const bpm = parseInt(document.getElementById('bpmInput').value) || null;
        const mode = document.getElementById('modeSelect').value;
        const harmonyMode = document.getElementById('harmonyModeSelect').value;

        // Create engine
        const engine = new ChordEnginePro();
        
        showProgress(10);

        // Detect chords
        const result = await engine.detect(state.audioBuffer, {
          mode: mode,
          bpm: bpm,
          harmonyMode: harmonyMode
        });

        showProgress(90);

        // Update state
        state.timeline = result.chords;
        state.key = result.key;
        state.bpm = result.bpm;
        state.mode = result.mode;
        state.stats = result.stats;

        // Update UI
        updateResults();
        
        showProgress(100);
        showStatus('âœ… × ×™×ª×•×— ×”×•×©×œ×!', 'success');

        // Enable playback
        document.getElementById('playBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = false;
        document.getElementById('stopBtn').disabled = false;

      } catch (error) {
        console.error('Analysis error:', error);
        showStatus('âŒ ×©×’×™××” ×‘× ×™×ª×•×—: ' + error.message, 'error');
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'ğŸ¸ × ×ª×— ××§×•×¨×“×™×';
        setTimeout(() => hideProgress(), 1000);
      }
    }

    function updateResults() {
      // Update key info
      const keyName = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'][state.key.root];
      document.getElementById('detectedKey').textContent = keyName + (state.key.minor ? 'm' : '');
      document.getElementById('detectedBpm').textContent = state.bpm;
      document.getElementById('detectedMode').textContent = state.mode || 'Major';

      // Update stats
      if (state.stats) {
        document.getElementById('statsGrid').style.display = 'grid';
        document.getElementById('statTotalChords').textContent = state.stats.totalChords || state.timeline.length;
        document.getElementById('statExtensions').textContent = state.stats.extensionsDetected || 0;
        document.getElementById('statInversions').textContent = state.stats.inversionsDetected || 0;
        document.getElementById('statModulations').textContent = state.stats.modulationsDetected || 0;
        document.getElementById('statConfidence').textContent = state.stats.avgConfidence || '0';
        document.getElementById('statProcessingTime').textContent = state.stats.processingTime || '0s';
      }

      // Update sheet
      refreshSheet();
    }

    function refreshSheet() {
      const sheetEl = document.getElementById('sheetTab');
      const capo = parseInt(document.getElementById('capoInput').value) || 0;

      if (!state.timeline || state.timeline.length === 0) {
        sheetEl.innerHTML = '<div style="color:#64748b;text-align:center;padding:40px">â³ ××™×Ÿ ××§×•×¨×“×™×</div>';
        return;
      }

      // Apply capo
      const chords = state.timeline.map(ch => ({
        time: ch.t + (state.gateTime || 0),
        label: applyCapo(sanitizeLabel(ch.label), capo)
      }));

      // Build sheet
      let html = '<div style="line-height:2">';
      
      for (let i = 0; i < chords.length; i++) {
        const chord = chords[i];
        const nextChord = chords[i + 1];
        
        html += `<span class="chord">${chord.label}</span>`;
        
        if (nextChord) {
          const duration = nextChord.time - chord.time;
          const spaces = Math.max(2, Math.floor(duration * 2));
          html += ' '.repeat(spaces);
        }
        
        if ((i + 1) % 8 === 0) {
          html += '<br>';
        }
      }
      
      html += '</div>';
      
      sheetEl.className = 'sheet-tab ltr';
      sheetEl.innerHTML = html;
    }

    function sanitizeLabel(label) {
      if (!label) return '';
      return label.trim();
    }

    function applyCapo(label, capo) {
      if (!capo || capo === 0) return label;
      
      const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      const match = label.match(/^([A-G][#b]?)(.*)/);
      
      if (!match) return label;
      
      let rootNote = match[1];
      const quality = match[2];
      
      // Convert to index
      let idx = notes.indexOf(rootNote.replace('b', '#'));
      if (idx === -1) return label;
      
      // Apply capo (transpose down)
      idx = (idx - capo + 12) % 12;
      
      return notes[idx] + quality;
    }

    function togglePlayback() {
      if (state.isPlaying) {
        pausePlayback();
      } else {
        playAudio();
      }
    }

    function playAudio() {
      if (!state.audioBuffer) return;

      if (!state.audioContext) {
        state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      state.source = state.audioContext.createBufferSource();
      state.source.buffer = state.audioBuffer;
      state.source.connect(state.audioContext.destination);
      state.source.start(0, state.currentTime);
      
      state.isPlaying = true;
      document.getElementById('playBtn').textContent = 'â¸ï¸ ×”×©×”×”';
    }

    function pausePlayback() {
      if (state.source) {
        state.source.stop();
        state.source = null;
      }
      state.isPlaying = false;
      document.getElementById('playBtn').textContent = 'â–¶ï¸ × ×’×Ÿ';
    }

    function stopPlayback() {
      pausePlayback();
      state.currentTime = 0;
    }

    function exportChordPro() {
      if (!state.timeline || state.timeline.length === 0) {
        showStatus('âŒ ××™×Ÿ ××§×•×¨×“×™× ×œ×™×™×¦×•×', 'error');
        return;
      }

      const capo = parseInt(document.getElementById('capoInput').value) || 0;
      const keyName = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'][state.key.root];
      
      let output = `{title: Untitled}\n`;
      output += `{artist: Unknown}\n`;
      output += `{key: ${keyName}${state.key.minor ? 'm' : ''}}\n`;
      if (capo > 0) output += `{capo: ${capo}}\n`;
      output += `\n`;

      for (const chord of state.timeline) {
        const label = applyCapo(sanitizeLabel(chord.label), capo);
        output += `[${label}] `;
      }

      downloadFile('chords.chopro', output);
      showStatus('âœ… ChordPro exported!', 'success');
    }

    function exportJSON() {
      if (!state.timeline || state.timeline.length === 0) {
        showStatus('âŒ ××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×', 'error');
        return;
      }

      const data = {
        key: state.key,
        bpm: state.bpm,
        mode: state.mode,
        chords: state.timeline,
        stats: state.stats
      };

      downloadFile('chords.json', JSON.stringify(data, null, 2));
      showStatus('âœ… JSON exported!', 'success');
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function showStatus(message, type) {
      const status = document.getElementById('statusBox');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
    }

    function showProgress(percent) {
      document.getElementById('progressBar').style.display = 'block';
      document.getElementById('progressFill').style.width = percent + '%';
    }

    function hideProgress() {
      document.getElementById('progressBar').style.display = 'none';
    }

    // Auto-update sheet on capo change
    document.getElementById('capoInput').addEventListener('change', refreshSheet);

    console.log('ğŸ¸ ChordFinder Pro ULTIMATE v2.2.0');
    console.log('âœ¨ All enhancements loaded and ready!');
  </script>
</body>
</html>
