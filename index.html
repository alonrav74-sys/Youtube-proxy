<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ChordFinderPro v14.36 INTEGRATED ğŸµ Enhanced</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="ğŸµ ×–×™×”×•×™ ××§×•×¨×“×™× ××ª×§×“× ×¢× AI - ×ª××™×›×” ×‘-YouTube, inversions, extensions, ×•×¡× ×›×¨×•×Ÿ lyrics" />
  <meta name="theme-color" content="#38bdf8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ChordFinder Pro" />
  <meta name="mobile-web-app-capable" content="yes" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon512.png" />
  <link rel="apple-touch-icon" href="icon192.png" />
  
  <style>
    :root{--bg:#0b1022;--panel:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--card:#0a1324;--border:#1b2333;--brand:#22c55e;--accent:#38bdf8;--alert:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);direction:rtl}
    .wrap{max-width:1200px;margin:auto;padding:18px;padding-bottom:80px}
    h1{margin:6px 0 10px;font-size:24px}
    .muted{color:var(--muted);font-size:14px}
    .panel{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"], select, button, input[type="number"], input[type="text"]{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;appearance:none;font-weight:700;cursor:pointer}
    input[type="text"]{width:100%;max-width:500px;font-weight:400}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1221;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px}
    .badge.pro{border-color:#664d23;background:#2e1f0d;color:#ffd7a3}
    .badge.whisper{border-color:#38bdf8;background:#0a1f2e;color:#bae6fd}
    .badge.bass{border-color:#f59e0b;background:#3a2a0c;color:#fff0d9}
    .badge.refiner{border-color:#a855f7;background:#2e1f3a;color:#e9d5ff}
   .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #2a3d55;margin:2px 4px;background:#0b1221}
    .ok{border-color:#1f5f3f;color:#d7ffe6;background:#0d2e1f}
    .err{border-color:#5f2323;color:#ffe0e0;background:#3f1d1d}
    .warn{border-color:#8a6a1f;color:#fff0d9;background:#3a2a0c}
  </style>
</head>
<body>

  <div class="wrap">
    <h1>Chord Finder Pro v14.36 MOBILE
      <span class="badge pro">AI + Profiles</span>
      <span class="badge whisper">Groq Whisper</span>
      <span class="badge bass">ğŸ¸ Bass</span>
      <span class="badge refiner">ğŸµ M/m</span>
    </h1>
    <div class="muted">
      ××§×•×¨×“×™× ××¢×œ ××™×œ×™× ×‘×–××Ÿ ×××ª + ×“×£ × ×’×™× ×” ××œ×. RTL/LTR ××•×˜×•××˜×™.<br>
      <small style="opacity:0.7;font-size:11px">
        Powered by <strong>Groq Whisper</strong> â€¢ 
        Harmonic AI + Auto Profiles + BassEngine + MajorMinorRefiner â€¢ 
        Built by <strong>Alon</strong>
      </small>
    </div>

    <section class="panel">
      <div class="row">
        <input id="file" type="file" accept="audio/*,video/*" />
        <button id="analyzeBtn">× ×ª×—</button>
        <button id="playBtn" disabled>â–¶ ×”×¤×¢×œ</button>
      </div>

      <div id="status" class="pill ok" style="display:none"></div>
      <div id="error" class="pill err" style="display:none"></div>

      <div class="row" style="margin-top:8px">
        <span class="badge">BPM: <b id="bpm">â€”</b></span>
        <span class="badge">××©×š: <b id="dur">â€”</b></span>
        <span class="badge">×¡×•×œ×: <b id="keyBadge">â€”</b></span>
        <span class="badge">××¦×‘: <b id="modeBadge">â€”</b></span>
      </div>
    </section>

    <section class="panel">
      <h2>×ª×¦×•×’×” ×—×™×”</h2>
      <audio id="player" controls preload="auto" crossorigin="anonymous" style="width:100%"></audio>
      <div style="text-align:center;font-size:42px;font-weight:800;margin:20px" id="liveChord">â€”</div>
    </section>
  </div>

<!-- âœ… CORRECTED - Load MOBILE versions -->
<script src="BassEngine_MOBILE.js"></script>
<script src="MajorMinorRefiner_MOBILE.js"></script>
<script src="ChordEngine_MOBILE.js"></script>

<script>
let engine;

window.addEventListener('DOMContentLoaded', () => {
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('error');
  
  // Check if engine loaded
  if (typeof ChordEngineEnhanced === 'undefined') {
    errorEl.textContent = 'âŒ ChordEngine_MOBILE.js ×œ× × ×˜×¢×Ÿ! ×•×“× ×©×”×§×‘×¦×™× ×‘×ª×™×§×™×™×”.';
    errorEl.style.display = 'inline-flex';
    return;
  }
  
  try {
    engine = new ChordEngineEnhanced();
    
    const hasBass = typeof BassEngine !== 'undefined';
    const hasRefiner = typeof MajorMinorRefiner !== 'undefined';
    
    console.log('âœ… ChordFinderPro MOBILE initialized');
    console.log(`   ChordEngine: âœ…`);
    console.log(`   BassEngine: ${hasBass ? 'âœ…' : 'âŒ'}`);
    console.log(`   MajorMinorRefiner: ${hasRefiner ? 'âœ…' : 'âŒ'}`);
    
    statusEl.textContent = 'âœ… ××•×›×Ÿ! ×‘×—×¨ ×§×•×‘×¥ ×•×œ×—×¥ "× ×ª×—"';
    statusEl.style.display = 'inline-flex';
    
  } catch(e) {
    errorEl.textContent = 'âŒ ×©×’×™××”: ' + e.message;
    errorEl.style.display = 'inline-flex';
  }
});

const analyzeBtn = document.getElementById('analyzeBtn');
const fileEl = document.getElementById('file');
const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const player = document.getElementById('player');
const bpmEl = document.getElementById('bpm');
const durEl = document.getElementById('dur');
const keyBadge = document.getElementById('keyBadge');
const modeBadge = document.getElementById('modeBadge');
const liveChordEl = document.getElementById('liveChord');
const playBtn = document.getElementById('playBtn');

analyzeBtn.onclick = async () => {
  const file = fileEl.files?.[0];
  if (!file) {
    errorEl.textContent = 'âš ï¸ ×‘×—×¨ ×§×•×‘×¥ ××•×“×™×•';
    errorEl.style.display = 'inline-flex';
    return;
  }
  
  try {
    statusEl.textContent = 'ğŸ”„ ×× ×ª×—...';
    statusEl.className = 'pill warn';
    statusEl.style.display = 'inline-flex';
    errorEl.style.display = 'none';
    
    // Decode audio
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    await ctx.resume();
    const arrayBuffer = await file.arrayBuffer();
    const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
    
    bpmEl.textContent = '120';
    durEl.textContent = audioBuffer.duration.toFixed(1) + 's';
    player.src = URL.createObjectURL(file);
    
    // Detect chords
    const result = await engine.detect(audioBuffer, {
      useBassEngine: true,
      useMajorMinorRefiner: true,
      minConfidenceToOverride: 0.40,
      decisionThreshold: 0.15,
      debug: true
    });
    
    const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    keyBadge.textContent = NOTES[result.key.root] + (result.key.minor ? 'm' : '');
    modeBadge.textContent = result.key.minor ? 'Minor' : 'Major';
    
    statusEl.textContent = `âœ… ${result.chords.length} ××§×•×¨×“×™× ×–×•×”×•!`;
    statusEl.className = 'pill ok';
    
    // Setup playback
    let currentChordIndex = 0;
    player.ontimeupdate = () => {
      const t = player.currentTime;
      while (currentChordIndex < result.chords.length - 1 && 
             result.chords[currentChordIndex + 1].t <= t) {
        currentChordIndex++;
      }
      if (result.chords[currentChordIndex]) {
        liveChordEl.textContent = result.chords[currentChordIndex].label;
      }
    };
    
    playBtn.disabled = false;
    
  } catch (e) {
    console.error(e);
    errorEl.textContent = 'âŒ ×©×’×™××”: ' + e.message;
    errorEl.style.display = 'inline-flex';
    statusEl.style.display = 'none';
  }
};

playBtn.onclick = async () => {
  try {
    await player.play();
  } catch (e) {
    alert('×œ×—×¥ â–¶ï¸ ×‘× ×’×Ÿ');
  }
};
</script>

</body>
</html>
