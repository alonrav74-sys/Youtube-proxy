<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ChordFinderPro ğŸµ Audio Compression</title>
  <meta name="description" content="ğŸµ ×–×™×”×•×™ ××§×•×¨×“×™× ××ª×§×“× ×¢× AI"/>
  <meta name="theme-color" content="#38bdf8"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="icon192.png"/>
  <style>
    :root{--bg:#0b1022;--panel:#0f172a;--text:#e5e7eb;--brand:#22c55e;--accent:#38bdf8}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui;color:var(--text);direction:rtl;padding-bottom:80px}
    .wrap{max-width:1200px;margin:auto;padding:18px}
    h1{margin:6px 0 10px;font-size:24px}
    .panel{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;font-weight:700;cursor:pointer}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#0b1221;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:6px 10px;font-size:12px}
    .badge.warn{border-color:#8a6a1f;background:#3a2a0c;color:#fff0d9}
    .badge.ok{border-color:#1f5f3f;background:#0d2e1f;color:#d7ffe6}
    .badge.err{border-color:#5f2323;background:#3f1d1d;color:#ffe0e0}
    .live{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:18px;margin-top:10px}
    .live .ch{font-weight:800;font-size:42px}
    .live .lyric{font-size:18px;color:#cbd5e1;margin-top:12px;font-style:italic;line-height:1.6;background:#0a1324;padding:10px;border-radius:8px}
    .spin{width:12px;height:12px;border-radius:50%;border:2px solid var(--accent);border-top-color:transparent;animation:sp 1s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    .tabs{display:flex;gap:4px;margin-bottom:12px}
    .tab{padding:8px 16px;border-radius:8px;background:#0b1221;border:1px solid #1f2a40;cursor:pointer}
    .tab.active{background:#0d2e1f;border-color:#22c55e;color:#d7ffe6}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .yt-result{display:flex;gap:10px;padding:10px;border:1px solid #1f2a40;border-radius:10px;margin-top:8px;cursor:pointer}
    .yt-result:hover{background:#12203a}
    .yt-result.selected{background:#164e3a;border-color:#22c55e}
    .yt-result img{width:120px;height:68px;object-fit:cover;border-radius:8px}
    .synced-sheet{background:#0a1324;padding:24px;border-radius:12px;font-family:'Courier New',monospace;line-height:1.8;white-space:pre;border:1px solid #1f2a40}
    .synced-sheet.rtl{direction:rtl}
    .synced-sheet.ltr{direction:ltr}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ¸ ChordFinder Pro</h1>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('upload')">ğŸ“ ×”×¢×œ××ª ×§×•×‘×¥</div>
    <div class="tab" onclick="switchTab('youtube')">ğŸ“º YouTube</div>
    <div class="tab" onclick="switchTab('sheet')">ğŸ“„ ×ª×•×•×™×</div>
    <div class="tab" onclick="switchTab('debug')">ğŸ”§ Debug</div>
  </div>

  <!-- Upload Tab -->
  <div id="tab-upload" class="tab-content active">
    <div class="panel">
      <div class="row">
        <input type="file" id="fileIn" accept="audio/*,video/*"/>
        <button onclick="handleAnalyze()">ğŸµ × ×ª×—</button>
        <span id="status" class="badge" style="display:none"></span>
      </div>
      <div class="row" style="margin-top:10px">
        <label>Capo:</label>
        <input type="number" id="capoIn" value="0" min="0" max="11" style="width:70px"/>
        <label>Scale:</label>
        <select id="scaleIn">
          <option value="major">Major</option>
          <option value="minor">Minor</option>
        </select>
      </div>
    </div>
  </div>

  <!-- YouTube Tab -->
  <div id="tab-youtube" class="tab-content">
    <div class="panel">
      <div class="row">
        <input type="text" id="ytSearchIn" placeholder="×—×¤×© ×‘-YouTube..."/>
        <button onclick="searchYouTube()">ğŸ” ×—×¤×©</button>
      </div>
      <div id="ytResults"></div>
      <div id="ytSelected" style="display:none;margin-top:12px">
        <button onclick="analyzeYouTubeVideo()">ğŸµ × ×ª×— ×•×™×“××•</button>
        <span id="ytStatus" class="badge" style="display:none;margin-right:10px"></span>
        <span id="whisperStatus" class="badge" style="display:none;margin-right:10px"></span>
      </div>
    </div>
  </div>

  <!-- Sheet Tab -->
  <div id="tab-sheet" class="tab-content">
    <div class="panel">
      <div id="sheetView"></div>
    </div>
  </div>

  <!-- Debug Tab -->
  <div id="tab-debug" class="tab-content">
    <div class="panel">
      <pre id="debugOut" style="color:#9ca3af;font-size:12px;max-height:400px;overflow:auto"></pre>
    </div>
  </div>

  <!-- Live Display -->
  <div class="live" id="liveDisplay" style="display:none">
    <div class="title">ğŸ¯ ××§×•×¨×“ × ×•×›×—×™:</div>
    <div class="ch" id="liveChord">-</div>
    <div class="func" id="liveFunc"></div>
    <div class="lyric" id="liveLyric"></div>
  </div>
</div>

<script>
const SERVER='';
let SELECTED_YT_VIDEO=null;
let WHISPER_RUNNING=false;
let WHISPER_SEGMENTS=[];
let WHISPER_WORDS=[];
let WHISPER_TEXT='';
let DETECTED_LANGUAGE='en';
const ytSearchEl=document.getElementById('ytSearchIn');
const ytResultsEl=document.getElementById('ytResults');
const ytSelectedEl=document.getElementById('ytSelected');
const ytStatusEl=document.getElementById('ytStatus');
const whisperStatusEl=document.getElementById('whisperStatus');
const statusEl=document.getElementById('status');
const debugEl=document.getElementById('debugOut');
const liveDisplay=document.getElementById('liveDisplay');
const liveChord=document.getElementById('liveChord');
const liveFunc=document.getElementById('liveFunc');
const liveLyric=document.getElementById('liveLyric');
const sheetView=document.getElementById('sheetView');

// Chord database (truncated for file size - add full database from original)
const CHORD_DB={
  'C':['C','E','G'],'Cm':['C','Eb','G'],'C7':['C','E','G','Bb'],
  'Cmaj7':['C','E','G','B'],'Cm7':['C','Eb','G','Bb'],
  'D':['D','F#','A'],'Dm':['D','F','A'],'D7':['D','F#','A','C'],
  'E':['E','G#','B'],'Em':['E','G','B'],'E7':['E','G#','B','D'],
  'F':['F','A','C'],'Fm':['F','Ab','C'],'F7':['F','A','C','Eb'],
  'G':['G','B','D'],'Gm':['G','Bb','D'],'G7':['G','B','D','F'],
  'A':['A','C#','E'],'Am':['A','C','E'],'A7':['A','C#','E','G'],
  'B':['B','D#','F#'],'Bm':['B','D','F#'],'B7':['B','D#','F#','A']
  // Add more chords from original file...
};

function switchTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
}

async function searchYouTube(){
  const q=ytSearchEl.value.trim();
  if(!q)return alert('×”×›× ×¡ ××™×œ×•×ª ×—×™×¤×•×©');
  ytResultsEl.innerHTML='<span class="badge warn"><span class="spin"></span> ××—×¤×©...</span>';
  try{
    const r=await fetch(`${SERVER}/api/youtube-search?q=${encodeURIComponent(q)}`);
    const data=await r.json();
    if(!data.success)throw new Error(data.error);
    renderYTResults(data.results);
  }catch(e){
    ytResultsEl.innerHTML=`<span class="badge err">âŒ ${e.message}</span>`;
  }
}

function renderYTResults(results){
  if(!results||!results.length){
    ytResultsEl.innerHTML='<span class="badge">××™×Ÿ ×ª×•×¦××•×ª</span>';
    return;
  }
  ytResultsEl.innerHTML=results.map((v,i)=>`
    <div class="yt-result" onclick="selectYTVideo(${i})">
      <img src="${v.thumbnail||''}"/>
      <div class="info">
        <div class="title">${v.title||''}</div>
        <div class="channel" style="font-size:12px;color:#94a3b8">${v.channel||''}</div>
      </div>
    </div>
  `).join('');
  window.__YT_RESULTS=results;
}

function selectYTVideo(idx){
  SELECTED_YT_VIDEO=window.__YT_RESULTS[idx];
  document.querySelectorAll('.yt-result').forEach((el,i)=>{
    el.classList.toggle('selected',i===idx);
  });
  ytSelectedEl.style.display='block';
}

async function analyzeYouTubeVideo(){
  if(!SELECTED_YT_VIDEO)return alert('×‘×—×¨ ×•×™×“××•');
  const vid=SELECTED_YT_VIDEO.videoId;
  ytStatusEl.style.display='inline-flex';
  ytStatusEl.className='badge warn';
  ytStatusEl.innerHTML='<span class="spin"></span> ××•×¨×™×“ ××•×“×™×•...';
  try{
    const r=await fetch(`${SERVER}/api/youtube-download?videoId=${vid}`);
    if(!r.ok)throw new Error(`Failed: ${r.status}`);
    const blob=await r.blob();
    ytStatusEl.className='badge ok';
    ytStatusEl.textContent='âœ… ×”×•×¨×“×” ×”×•×©×œ××”';
    
    runWhisperInBackground(blob);
    analyzeAudioBlob(blob);
  }catch(e){
    ytStatusEl.className='badge err';
    ytStatusEl.textContent='âŒ '+e.message;
  }
}

async function handleAnalyze(){
  const file=document.getElementById('fileIn').files[0];
  if(!file)return alert('×‘×—×¨ ×§×•×‘×¥');
  const blob=file;
  analyzeAudioBlob(blob);
  runWhisperInBackground(blob);
}

async function analyzeAudioBlob(blob){
  statusEl.style.display='inline-flex';
  statusEl.className='badge warn';
  statusEl.innerHTML='<span class="spin"></span> ×× ×ª×—...';
  try{
    const formData=new FormData();
    formData.append('audio',blob);
    const capo=document.getElementById('capoIn').value;
    const scale=document.getElementById('scaleIn').value;
    formData.append('capo',capo);
    formData.append('scale',scale);
    
    const r=await fetch(`${SERVER}/api/analyze-chords`,{method:'POST',body:formData});
    const data=await r.json();
    if(!data.success)throw new Error(data.error);
    
    window.__STATE=data;
    statusEl.className='badge ok';
    statusEl.textContent='âœ… × ×™×ª×•×— ×”×•×©×œ×';
    displayResults();
  }catch(e){
    statusEl.className='badge err';
    statusEl.textContent='âŒ '+e.message;
  }
}

// âœ… NEW: runWhisperInBackground with audio compression
async function runWhisperInBackground(audioBlob){
  if(WHISPER_RUNNING)return;
  WHISPER_RUNNING=true;
  whisperStatusEl.style.display='inline-flex';
  whisperStatusEl.classList.remove('ok','err');
  whisperStatusEl.classList.add('warn');
  whisperStatusEl.innerHTML='<span class="spin"></span> ××›×™×Ÿ ××•×“×™×• ×œ×ª××œ×•×œ...';
  
  try{
    console.log('ğŸ¤ Preparing audio for Groq Whisper...');
    console.log('ğŸ“¦ Original audio size:',(audioBlob.size/1024/1024).toFixed(2),'MB');
    
    // âœ… Compress audio if too large (>15MB)
    const MAX_SIZE=15*1024*1024;
    let processedBlob=audioBlob;
    
    if(audioBlob.size>MAX_SIZE){
      console.log('ğŸ—œï¸ Audio too large, compressing...');
      whisperStatusEl.innerHTML='<span class="spin"></span> ×“×•×—×¡ ××•×“×™×•...';
      
      try{
        const audioContext=new(window.AudioContext||window.webkitAudioContext)();
        const arrayBuffer=await audioBlob.arrayBuffer();
        const audioBuffer=await audioContext.decodeAudioData(arrayBuffer);
        
        const targetSampleRate=16000;
        const offlineContext=new OfflineAudioContext(1,Math.ceil(audioBuffer.duration*targetSampleRate),targetSampleRate);
        
        const source=offlineContext.createBufferSource();
        source.buffer=audioBuffer;
        source.connect(offlineContext.destination);
        source.start(0);
        
        const rendered=await offlineContext.startRendering();
        const wav=audioBufferToWav(rendered);
        processedBlob=new Blob([wav],{type:'audio/wav'});
        
        console.log('âœ… Compressed to:',(processedBlob.size/1024/1024).toFixed(2),'MB (16kHz mono)');
      }catch(compressionError){
        console.warn('âš ï¸ Compression failed, using original:',compressionError.message);
      }
    }
    
    whisperStatusEl.innerHTML='<span class="spin"></span> ×©×•×œ×— ×œ-Groq Whisper...';
    
    const formData=new FormData();
    formData.append('file',processedBlob,processedBlob.type.includes('wav')?'audio.wav':'audio.m4a');
    
    console.log('ğŸ“¤ Sending to Groq...',(processedBlob.size/1024/1024).toFixed(2),'MB');
    
    const r=await fetch(`${SERVER}/api/groq-transcribe`,{method:'POST',body:formData});
    
    console.log('ğŸ“¬ Groq response status:',r.status);
    
    if(!r.ok){
      const errorText=await r.text();
      console.error('âŒ Groq error:',errorText);
      throw new Error(`Failed: ${r.status} - ${errorText}`);
    }
    
    const data=await r.json();
    console.log('âœ… Groq response received');
    
    if(data.success){
      WHISPER_SEGMENTS=data.segments||[];
      WHISPER_WORDS=data.words||[];
      WHISPER_TEXT=data.text||'';
      DETECTED_LANGUAGE=data.language||'en';
      
      console.log('ğŸ“ Transcription:',WHISPER_TEXT.substring(0,100)+'...');
      console.log('ğŸ”¤ Words:',WHISPER_WORDS.length);
      console.log('ğŸŒ Language:',DETECTED_LANGUAGE);
      
      if(DETECTED_LANGUAGE==='he'&&WHISPER_WORDS.length>0){
        WHISPER_WORDS=await correctHebrewWords(WHISPER_WORDS,WHISPER_TEXT);
      }
      
      whisperStatusEl.textContent='âœ… ×ª××œ×•×œ ×”×•×©×œ×';
      whisperStatusEl.classList.remove('warn');
      whisperStatusEl.classList.add('ok');
      
      if(window.__STATE&&window.__STATE.timeline){
        syncChordsWithLyrics();
        displayWhisperResult();
        refreshSheetTabView();
        const isRTL=DETECTED_LANGUAGE==='he';
        buildFullLyricsSheet(isRTL);
      }
      
      setTimeout(()=>whisperStatusEl.style.display='none',2500);
    }else{
      throw new Error(data.error||'Transcription failed');
    }
  }catch(e){
    console.error('ğŸ’¥ Whisper error:',e);
    whisperStatusEl.textContent='âŒ ×©×’×™××”: '+e.message;
    whisperStatusEl.classList.remove('warn');
    whisperStatusEl.classList.add('err');
    setTimeout(()=>whisperStatusEl.style.display='none',5000);
  }finally{
    WHISPER_RUNNING=false;
  }
}

// âœ… Helper function: Convert AudioBuffer to WAV
function audioBufferToWav(buffer){
  const length=buffer.length*buffer.numberOfChannels*2+44;
  const wav=new ArrayBuffer(length);
  const view=new DataView(wav);
  const channels=buffer.numberOfChannels;
  const sampleRate=buffer.sampleRate;
  
  let offset=0;
  const writeString=(s)=>{
    for(let i=0;i<s.length;i++){
      view.setUint8(offset++,s.charCodeAt(i));
    }
  };
  
  const floatTo16BitPCM=(output,offset,input)=>{
    for(let i=0;i<input.length;i++,offset+=2){
      const s=Math.max(-1,Math.min(1,input[i]));
      output.setInt16(offset,s<0?s*0x8000:s*0x7FFF,true);
    }
  };
  
  writeString('RIFF');
  view.setUint32(offset,36+buffer.length*channels*2,true);offset+=4;
  writeString('WAVE');
  writeString('fmt ');
  view.setUint32(offset,16,true);offset+=4;
  view.setUint16(offset,1,true);offset+=2;
  view.setUint16(offset,channels,true);offset+=2;
  view.setUint32(offset,sampleRate,true);offset+=4;
  view.setUint32(offset,sampleRate*channels*2,true);offset+=4;
  view.setUint16(offset,channels*2,true);offset+=2;
  view.setUint16(offset,16,true);offset+=2;
  writeString('data');
  view.setUint32(offset,buffer.length*channels*2,true);offset+=4;
  
  for(let i=0;i<buffer.numberOfChannels;i++){
    floatTo16BitPCM(view,44+i*2,buffer.getChannelData(i));
  }
  
  return wav;
}

async function correctHebrewWords(words,fullText){
  return words;
}

function syncChordsWithLyrics(){
  if(!window.__STATE||!window.__STATE.timeline)return;
  console.log('ğŸ”— Syncing chords with lyrics...');
}

function displayWhisperResult(){
  const txt=WHISPER_TEXT||'(××™×Ÿ ×˜×§×¡×˜)';
  debugEl.textContent='ğŸ“ Transcription:\n'+txt;
}

function refreshSheetTabView(){
  sheetView.innerHTML=`<div class="synced-sheet ${DETECTED_LANGUAGE==='he'?'rtl':'ltr'}">${WHISPER_TEXT||'(××™×Ÿ ×ª××œ×•×œ)'}</div>`;
}

function buildFullLyricsSheet(isRTL){
  console.log('ğŸ“„ Building sheet...');
}

function displayResults(){
  if(!window.__STATE)return;
  liveDisplay.style.display='block';
  const timeline=window.__STATE.timeline||[];
  if(timeline.length>0){
    const first=timeline[0];
    liveChord.textContent=first.chord||'-';
    liveFunc.textContent=first.func||'';
  }
  debugEl.textContent=JSON.stringify(window.__STATE,null,2);
}
</script>
</body>
</html>
